{% extends "base.html" %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load bootstrap_icons %}
{% load static %}

{% block title %}User's submissions{% endblock %}

{% block featured %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="card-title mb-0">
                <i class="bi bi-person"></i> {{ currentUser.first_name }} {{ currentUser.last_name }}'s Profile
            </h4>
            <button class="btn btn-link text-decoration-none" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#instructionsCollapse" 
                    aria-expanded="true" 
                    aria-controls="instructionsCollapse">
                <i class="bi bi-chevron-up"></i>
                <span class="instructions-toggle-text">Hide Instructions</span>
            </button>
        </div>
        
        <div class="collapse show" id="instructionsCollapse">
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle"></i> User Information</h5>
                <p class="mb-0">You can edit their submissions below (just as on the homepage). You can add a submission or poster for this user by clicking the buttons below.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const collapse = document.getElementById('instructionsCollapse');
    const toggleBtn = collapse.previousElementSibling.querySelector('button');
    const toggleIcon = toggleBtn.querySelector('i');
    const toggleText = toggleBtn.querySelector('.instructions-toggle-text');
    
    // Load saved state
    const isCollapsed = localStorage.getItem('userDetailInstructionsCollapsed') === 'true';
    if (isCollapsed) {
        collapse.classList.remove('show');
        toggleIcon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        toggleText.textContent = 'Show Instructions';
    }

    collapse.addEventListener('hide.bs.collapse', function () {
        toggleIcon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        toggleText.textContent = 'Show Instructions';
        localStorage.setItem('userDetailInstructionsCollapsed', 'true');
    });

    collapse.addEventListener('show.bs.collapse', function () {
        toggleIcon.classList.replace('bi-chevron-down', 'bi-chevron-up');
        toggleText.textContent = 'Hide Instructions';
        localStorage.setItem('userDetailInstructionsCollapsed', 'false');
    });
});
</script>
{% endblock %}

{% block page_content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-person-vcard"></i> User Profile
            {% if moderator %}
            <a href="edit/" class="btn btn-light btn-sm float-end">
                <i class="bi bi-pencil-square"></i> Edit Profile
            </a>
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><i class="bi bi-person-circle"></i> <strong>Name:</strong> {{ currentUser.first_name }} {{ currentUser.last_name }}</p>
                <p><i class="bi bi-building"></i> <strong>Program/School:</strong> {{ currentUser.organization }}</p>
                <p><i class="bi bi-envelope"></i> <strong>Email:</strong> {{ currentUser.email }}</p>
                <p><i class="bi bi-envelope-at"></i> <strong>Alternate email:</strong> {{ currentUser.alt_email }}</p>
            </div>
            <div class="col-md-6">
                <p><i class="bi bi-telephone"></i> <strong>Phone:</strong> {{ currentUser.phone }}</p>
                <p><i class="bi bi-phone"></i> <strong>Alternate phone:</strong> {{ currentUser.alt_phone }}</p>
                <p><i class="bi bi-printer"></i> <strong>Fax:</strong> {{ currentUser.fax }}</p>
                <p><i class="bi bi-geo-alt"></i> <strong>Address:</strong><br>
                    {{ currentUser.address }}<br>
                    {{ currentUser.city }}, {{ currentUser.state }} {{ currentUser.zip }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <a href="submission/add/" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> New Submission for {{ currentUser.first_name }}
    </a>
</div>

<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-list-ul"></i> Submissions
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover small submission-table mb-0">
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="pb-5"></div>

<style>
    .dropdown-toggle.btn {
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dropdown-menu {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .dropdown-item {
        cursor: pointer;
        padding: .25rem .5rem;
    }

    .table-responsive {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    .sort-btn {
        cursor: pointer;
    }

    .sort-btn:hover {
        background-color: rgba(0,0,0,.05);
    }

    .stealth {
        text-decoration: none;
    }

    .overflow-wrap {
        max-width: 200px;
        overflow-wrap: break-word;
        word-wrap: break-word;
    }
</style>

<script>
  const table = document.querySelector('.submission-table');
  const moderatorText = "{{ moderator }}"
  const moderator = moderatorText == 'True'

  class App {
    tableObjects
    tableHeader = `
  <thead>
    <tr>
        <th class="sort-btn" data-field="user.first_name"><div class="d-flex align-items-center">User<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="title"><div class="d-flex align-items-center">Title<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="category.name"><div class="d-flex align-items-center">Category<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="grade_range"><div class="d-flex align-items-center">Grade<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="submission_type"><div class="d-flex align-items-center">Submission type<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="group"><div class="d-flex align-items-center">Presenting group<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="status_display"><div class="d-flex align-items-center">Status<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
        <th class="sort-btn" data-field="updated"><div class="d-flex align-items-center">Action<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:block;"></i></span></div></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
`
    tableBody
    activeValue
    activeEditButton
    sort = { field: 'updated', direction: 'desc'};


    constructor() {

        document.addEventListener('DOMContentLoaded', () => {
            this._loadTable(true, true);
        });

        this._clickSortCaret = this._clickSortCaret.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.sort-btn')) {
                    this._clickSortCaret(e);
                }
            });
        });

        this._clickApproveSubmission = this._clickApproveSubmission.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.submission-approve')) {
                    this._clickApproveSubmission(e);
                }
            });
        });

        this._clickUnapproveSubmission = this._clickUnapproveSubmission.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.submission-unapprove')) {
                    this._clickUnapproveSubmission(e);
                }
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.submission-retract')) {
                    this._clickUnapproveSubmission(e);
                }
            });
        });
    }

    _getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    _getSubmissions(){

        const user_id = "{{ currentUser.id }}";
        const user_param = `?user_id=${user_id}`
        const headers = { 'Content-Type': 'application/json' };
        return fetch(`/api/submission-poster/${user_param}`, { headers, })
            .then(res => res.json())
            .then(data => {
                this.tableObjects = data
            });

    }

    _getSubmission(submission_id){

        const headers = { 'Content-Type': 'application/json' };
        return fetch(`/api/submission/${submission_id}`, { headers, })
            .then(res => res.json())
            .then(data => {
                return data;
            });

    }


    async _loadTable(doFetch, sort, { field = 'updated', direction = 'desc' } = {}) {
        if ( doFetch == true ) {
            await this._getSubmissions()
        } 
        if (!sort) {
            field = this.sort.field;
            direction = this.sort.direction;
        }

        console.log(field, direction)
            // Sort tableObjects if a field is specified
            if (field) {
                this.tableObjects.sort((a, b) => {
                    // Check if the first index of the field exists in a or b
                    const firstIndex = field.split('.')[0];
                    if (!(firstIndex in a)) return 1;
                    if (!(firstIndex in b)) return -1;

                    // Split the field string into an array and use reduce to access the nested property
                    let aField = field.split('.').reduce((o, i) => (o ? o[i] : undefined), a);
                    let bField = field.split('.').reduce((o, i) => (o ? o[i] : undefined), b);

                    // If aField or bField is undefined, sort it last
                    if (aField === undefined) return 1;
                    if (bField === undefined) return -1;

                    // Convert fields to lowercase if they are strings
                    if (typeof aField === 'string') aField = aField.toLowerCase();
                    if (typeof bField === 'string') bField = bField.toLowerCase();

                    if (aField < bField) return direction === 'asc' ? -1 : 1;
                    if (aField > bField) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

        table.innerHTML = this.tableHeader
        this.tableBody = document.querySelector('.submission-table tbody');
        this.tableObjects.forEach((tableObject) => {
            const html = this._buildRowHtml(tableObject);
            // const row = this.tableBody.insertRow();
            // row.innerHTML = html
            this.tableBody.insertAdjacentHTML('beforeend', html);
        });

    }

    _buildRowHtml(tableObject) {
        let category;
        let submission_type;
        let group;
        let detail_link;
        let edit_link;
        category = tableObject.category.name;
        submission_type = tableObject.submission_type;
        group = tableObject.group;
        detail_link = `/submission/${tableObject.id}/`;
        edit_link = detail_link + 'edit/';

        let approveTooltip;
        let approveButton
        if ( tableObject.status=="submitted" ) {
            approveTooltip = ' title="Approve"'
            approveButton = `{% bs_icon 'check-square-fill' extra_classes='submission-approve' color='green' %}`
        } else {
            approveTooltip = ''
            approveButton = `{% bs_icon 'check-square-fill' extra_classes='submission-approve' color='grey' %}`
        }

        let unapproveTooltip;
        let unapproveButton;
        if ( tableObject.status=="submitted" || tableObject.status=="approved") {
            unapproveTooltip = ' title="Unapprove"'
            unapproveButton = `{% bs_icon 'x-square-fill' extra_classes="submission-unapprove" color='darkred' %}`
        } else {
            unapproveTooltip = ''
            unapproveButton = `{% bs_icon 'x-square-fill' extra_classes="submission-unapprove" color='grey' %}`
        }
        
        let editTooltip;
        let editButton;
        let editHref;
        if ( tableObject.status=="in_progress" ) {
            editHref = edit_link;
            editTooltip = ' title="Edit"'
            editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='blue' %}`
        } else {
            if (moderator) {
                editHref = 'javascript:void(0)';
                editTooltip = ''
                editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='grey' %}`
            } else {
                if ( tableObject.status=="submitted" ) {
                    editHref = 'javascript:void(0)';
                    editTooltip = ' title="Retract submission to continue editing"'
                    editButton = `{% bs_icon 'arrow-counterclockwise' extra_classes="submission-retract" color='tomato' %}`
                } else {
                    editHref = 'javascript:void(0)';
                    editTooltip = ''
                    editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='grey' %}`
                }
            }

        }


        const html = `
        <tr data-id="${tableObject.id}" data-status="${tableObject.status}">
            <td>
                ${moderator ? `<a href='/user/${tableObject.user?.id}'>` : ``}
                    ${((tableObject.user?.first_name || '') + ' ' + (tableObject.user?.last_name || '')).substring(0, 30)}<br />
                ${moderator ? `</a>` : ``}
                    ${(tableObject.user?.organization || '').substring(0, 30)}<br />
                    ${(tableObject.user?.email || '').substring(0, 30)}

            </td>
            <td class="overflow-wrap">
                ${tableObject.title}
            </td>
            <td>
                ${category}
            </td>
            <td>
                ${tableObject.grade_range_display}
            </td>
            <td>
                ${submission_type}
            </td>
            <td>
                ${group}
            </td>
            <td>
                ${tableObject.status_display}
            </td>
            <td>
                ${moderator ? `<span>
                        <a class="stealth" href="javascript:void(0)"${approveTooltip}>
                            ${approveButton}
                        </a>
                </span>
                <span>
                        <a class="stealth" href="javascript:void(0)"${unapproveTooltip}>
                            ${unapproveButton}
                        </a>
                </span>
                <span> | </span>` : ``}
                <span>
                        <a class="stealth" href="${detail_link}" title="Info">
                            {% bs_icon 'info-circle-fill' extra_classes="submission-detail" %}
                        </a>
                </span>
                <span>
                        <a class="stealth" href="${editHref}"${editTooltip}>
                            ${editButton}
                        </a>
                </span>
                ${moderator ? `<span>
                        <a class="stealth" href="javascript:void(0)" title="Delete">
                            {% bs_icon 'trash3-fill' extra_classes="submission-delete" color='red' %}
                        </a>
                </span>` : ``}
            </td>
        </tr>
  `;
        return html
    }

    async _clickSortCaret(e) {
        const target = e.target;
        let thElement;

        if (target.tagName.toLowerCase() === 'th') {
            thElement = target;
        } else {
            thElement = target.closest('th');
        }

        const field = thElement.dataset.field;
        let direction;
        if ( field == this.sort.field ) {
            direction = this.sort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            direction = 'asc';
        }
        await this._loadTable(false, true, { field:field, direction:direction });
        
        const carets = document.querySelectorAll('.sort-caret');
        await carets.forEach(caret => caret.style.display = 'none');
        const thisColumn = document.querySelector(`.submission-table th[data-field="${field}"]`);
        if ( direction == 'asc' ) {
            const thisCaret = thisColumn.querySelector('.bi-caret-up-fill');
            thisCaret.style.display = 'block';
        } else {
            const thisCaret = thisColumn.querySelector('.bi-caret-down-fill');
            thisCaret.style.display = 'block';
        }

        this.sort = { field, direction };
    }

    async _clickApproveSubmission(e) {
        const row = e.target.closest('tr');
        const submission_id = row.dataset.id;
        const status = row.dataset.status;
        if (status == "submitted") {
            await this._updateSubmission(submission_id, 'approved');
            const updatedSubmission = await this._getSubmission(submission_id);
            // const html = this._buildRowHtml(updatedSubmission);
            // row.outerHTML = html;
            await this._loadTable(true, false);
        }

    }

    async _clickUnapproveSubmission(e) {
        const row = e.target.closest('tr');
        const submission_id = row.dataset.id;
        const status = row.dataset.status;
        if (status == "submitted" || status == "approved") {
            await this._updateSubmissionPartStatus(submission_id, 'review_status', 'pending')
            await this._updateSubmission(submission_id, 'in_progress');
            const updatedSubmission = await this._getSubmission(submission_id);
            // const html = this._buildRowHtml(updatedSubmission);
            // row.outerHTML = html;
            await this._loadTable(true, false);
        }

    }

    _updateSubmission(submission_id, status) {
            const body = JSON.stringify({
                status: status,});
            const csrftoken = this._getCookie('csrftoken');
            const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
            return fetch(`/api/submission-update/${submission_id}/`, {
                method: 'PATCH',
                headers,
                body: body,
            })
            .then(res => {
                res.json()
                // console.log(res)
            })
            .then(data => {
                console.log('Modified submission:', data);
                // Handle any further actions after modifying the submission
            })
            .catch(error => {
                console.error('Error modifying submission:', error);
                // Handle errors, if any
            });
    }

    _updateSubmissionPartStatus(submission_id, field, status) {

        const body = JSON.stringify({
            [field]: status});
        const csrftoken = this._getCookie('csrftoken');
        const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
        return fetch(`/api/submission-update/${submission_id}/`, {
            method: 'PATCH',
            headers,
            body: body,
        })
        .then(res => {
            res.json()
            console.log(res)
        })
        .then(data => {
            console.log('Modified submission status:', data);
            // Handle any further actions after modifying the submission
        })
        .catch(error => {
            console.error('Error modifying submission status:', error);
            // Handle errors, if any
        });
    }
  }
  const app = new App();
</script>

{% endblock %}
