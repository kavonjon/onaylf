{% extends "base.html" %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load bootstrap_icons %}
{% load static %}

{% block title %}Home{% endblock %}

{% block featured %}
Welcome, {{ currentUser.first_name }}<br />

This is your Homepage. On this page you can choose to enter a Performance (for all categories except Posters) or a Poster. We separated those for your convenience.<br />

You will also return to this page after submitting a Performance or Poster. You will be able to see all of your entries, their status, and go back into them to edit from here.

{% endblock %}


{% block page_content %}

{% if moderator %}{% else %}
<div class="mb-3">
    <a href="performance/add/" class="btn btn-primary">New Performance</a>
    <a href="poster/add/" class="btn btn-primary">New Poster</a>
</div>
{% endif %}

<div class="table-responsive">
    <table class="table table-striped small performance-table">
    <tbody>
    </tbody>
    </table>
</div>

<script>
  const table = document.querySelector('.performance-table');
  const moderatorText = "{{ moderator }}"
  const moderator = moderatorText == 'True'

  class App {
    tableObjects
    tableHeader = `
  <thead>
    <tr>
      <th>User</th>
      <th>Title</th>
      <th>Category</th>
      <th>Grade</th>
      <th>Performance type</th>
      <th>Group</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
`
    tableBody
    activeValue
    activeEditButton


    constructor() {

        document.addEventListener('DOMContentLoaded', this._loadTable.bind(this));

        this._clickApprovePerformance = this._clickApprovePerformance.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.performance-approve')) {
                    this._clickApprovePerformance(e);
                }
            });
        });

        this._clickUnapprovePerformance = this._clickUnapprovePerformance.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.performance-unapprove')) {
                    this._clickUnapprovePerformance(e);
                }
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.performance-retract')) {
                    this._clickUnapprovePerformance(e);
                }
            });
        });
    }

    _getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    _getPerformances(){

        let user_param;
        // console.log("moderator: " + moderator)
        if (moderator) {
            user_param = ""
        } else {
            const user_id = "{{ currentUser.id }}";
            user_param = `?user_id=${user_id}`
        }

        const headers = { 'Content-Type': 'application/json' };
        return fetch(`/api/performance-poster/${user_param}`, { headers, })
            .then(res => res.json())
            .then(data => {
                this.tableObjects = data
            });

    }

    _getPerformance(performance_id){

        const headers = { 'Content-Type': 'application/json' };
        return fetch(`/api/performance/${performance_id}`, { headers, })
            .then(res => res.json())
            .then(data => {
                return data;
            });

    }


    async _loadTable(sort=null) {
      await this._getPerformances()
      table.innerHTML = this.tableHeader
      this.tableBody = document.querySelector('.performance-table tbody');
      this.tableObjects.forEach((tableObject) => {
        const html = this._buildRowHtml(tableObject);
        // const row = this.tableBody.insertRow();
        // row.innerHTML = html
        this.tableBody.insertAdjacentHTML('beforeend', html);
      });

    }

    _buildRowHtml(tableObject) {
        let category;
        let performance_type;
        let group;
        let detail_link;
        let edit_link;
        if ( tableObject.poster ) {
            category = 'Poster';
            performance_type = 'Individual';
            group = '';
            detail_link = `/poster/${tableObject.id}/`;
            edit_link = detail_link + 'edit/';
        } else {
            category = tableObject.category.name;
            performance_type = tableObject.performance_type;
            group = tableObject.group;
            detail_link = `/performance/${tableObject.id}/`;
            edit_link = detail_link + 'edit/';
        }

        let approveTooltip;
        let approveButton
        if ( tableObject.status=="submitted" ) {
            approveTooltip = ' title="Approve"'
            approveButton = `{% bs_icon 'check-square-fill' extra_classes='performance-approve' color='green' %}`
        } else {
            approveTooltip = ''
            approveButton = `{% bs_icon 'check-square-fill' extra_classes='performance-approve' color='grey' %}`
        }

        let unapproveTooltip;
        let unapproveButton;
        if ( tableObject.status=="submitted" || tableObject.status=="approved") {
            unapproveTooltip = ' title="Unapprove"'
            unapproveButton = `{% bs_icon 'x-square-fill' extra_classes="performance-unapprove" color='darkred' %}`
        } else {
            unapproveTooltip = ''
            unapproveButton = `{% bs_icon 'x-square-fill' extra_classes="performance-unapprove" color='grey' %}`
        }
        
        let editTooltip;
        let editButton;
        let editHref;
        if ( tableObject.status=="in_progress" ) {
            editHref = edit_link;
            editTooltip = ' title="Edit"'
            editButton = `{% bs_icon 'pencil-square' extra_classes="performance-edit" color='blue' %}`
        } else {
            if (moderator) {
                editHref = 'javascript:void(0)';
                editTooltip = ''
                editButton = `{% bs_icon 'pencil-square' extra_classes="performance-edit" color='grey' %}`
            } else {
                if ( tableObject.status=="submitted" ) {
                    editHref = 'javascript:void(0)';
                    editTooltip = ' title="Retract submission to continue editing"'
                    editButton = `{% bs_icon 'arrow-counterclockwise' extra_classes="performance-retract" color='tomato' %}`
                } else {
                    editHref = 'javascript:void(0)';
                    editTooltip = ''
                    editButton = `{% bs_icon 'pencil-square' extra_classes="performance-edit" color='grey' %}`
                }
            }

        }


        const html = `
        <tr data-id="${tableObject.id}" data-status="${tableObject.status}">
            <td>
                ${moderator ? `<a href='/user/${tableObject.user.id}'>` : ``}
                    ${(tableObject.user.first_name + ' ' + tableObject.user.last_name).substring(0, 30)}<br />
                    ${(tableObject.user.email).substring(0, 30)}
                ${moderator ? `</a>` : ``}
            </td>
            <td class="overflow-wrap">
                ${tableObject.title}
            </td>
            <td>
                ${category}
            </td>
            <td>
                ${tableObject.grade_range_display}
            </td>
            <td>
                ${performance_type}
            </td>
            <td>
                ${group}
            </td>
            <td>
                ${tableObject.status_display}
            </td>
            <td>
                ${moderator ? `<span>
                        <a class="stealth" href="javascript:void(0)"${approveTooltip}>
                            ${approveButton}
                        </a>
                </span>
                <span>
                        <a class="stealth" href="javascript:void(0)"${unapproveTooltip}>
                            ${unapproveButton}
                        </a>
                </span>
                <span> | </span>` : ``}
                <span>
                        <a class="stealth" href="${detail_link}" title="Info">
                            {% bs_icon 'info-circle-fill' extra_classes="performance-detail" %}
                        </a>
                </span>
                <span>
                        <a class="stealth" href="${editHref}"${editTooltip}>
                            ${editButton}
                        </a>
                </span>
                ${moderator ? `<span>
                        <a class="stealth" href="javascript:void(0)" title="Delete">
                            {% bs_icon 'trash3-fill' extra_classes="performance-delete" color='red' %}
                        </a>
                </span>` : ``}
            </td>
        </tr>
  `;
        return html
    }


    async _clickApprovePerformance(e) {
        const row = e.target.closest('tr');
        const performance_id = row.dataset.id;
        const status = row.dataset.status;
        if (status == "submitted") {
            await this._updatePerformance(performance_id, 'approved');
            const updatedPerformance = await this._getPerformance(performance_id);
            const html = this._buildRowHtml(updatedPerformance);
            row.outerHTML = html;
        }

    }

    async _clickUnapprovePerformance(e) {
        const row = e.target.closest('tr');
        const performance_id = row.dataset.id;
        const status = row.dataset.status;
        if (status == "submitted" || status == "approved") {
            await this._updatePerformancePartStatus(performance_id, 'review_status', 'pending')
            await this._updatePerformance(performance_id, 'in_progress');
            const updatedPerformance = await this._getPerformance(performance_id);
            const html = this._buildRowHtml(updatedPerformance);
            row.outerHTML = html;
        }

    }

    _updatePerformance(performance_id, status) {
            const body = JSON.stringify({
                status: status,});
            const csrftoken = this._getCookie('csrftoken');
            const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
            return fetch(`/api/performance-update/${performance_id}/`, {
                method: 'PATCH',
                headers,
                body: body,
            })
            .then(res => {
                res.json()
                // console.log(res)
            })
            .then(data => {
                console.log('Modified performance:', data);
                // Handle any further actions after modifying the performance
            })
            .catch(error => {
                console.error('Error modifying performance:', error);
                // Handle errors, if any
            });
    }

    _updatePerformancePartStatus(performance_id, field, status) {

        const body = JSON.stringify({
            [field]: status});
        const csrftoken = this._getCookie('csrftoken');
        const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
        return fetch(`/api/performance-update/${performance_id}/`, {
            method: 'PATCH',
            headers,
            body: body,
        })
        .then(res => {
            res.json()
            console.log(res)
        })
        .then(data => {
            console.log('Modified performance status:', data);
            // Handle any further actions after modifying the performance
        })
        .catch(error => {
            console.error('Error modifying performance status:', error);
            // Handle errors, if any
        });
    }
  }
  const app = new App();
</script>

{% endblock %}
