{% extends "base.html" %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load bootstrap_icons %}
{% load static %}

{% block title %}Home{% endblock %}

{% block featured %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="card-title mb-0">
                <i class="bi bi-house-door"></i> Welcome, {{ currentUser.first_name }}
            </h4>
            <button class="btn btn-link text-decoration-none" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#instructionsCollapse" 
                    aria-expanded="true" 
                    aria-controls="instructionsCollapse">
                <i class="bi bi-chevron-up"></i>
                <span class="instructions-toggle-text">Hide Instructions</span>
            </button>
        </div>
        
        <div class="collapse show" id="instructionsCollapse">
            {% if moderator %}
                <div class="alert alert-info">
                    <h5><i class="bi bi-shield-check"></i> Moderator Instructions</h5>
                    <ul class="mb-0">
                        <li>View all submissions for the current fair. Click column headers to sort.</li>
                        <li>Approve/unapprove submissions in the "Action" column.</li>
                        <li>To edit performances, first unapprove them, then edit and resubmit.</li>
                        <li>Emails are sent on first submission and approval.</li>
                        <li>Click usernames to see their submission listings and add new submissions.</li>
                    </ul>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Submission Instructions</h5>
                    <ul class="mb-0">
                        <li>Click "New Submission" to add an entry.</li>
                        <li>View and edit submissions using the action buttons in the table below.</li>
                        <li>Status "Submitted" means complete but locked. Use "Retract submission" to edit again.</li>
                        <li>Status "Approved" means locked. Contact ONAYLF team for changes.</li>
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Initialize fairId from localStorage
const fairId = localStorage.getItem('viewFairId');
const fairParam = fairId ? `?fair_id=${fairId}` : '';

// Check if we need to redirect immediately
if (fairId && !window.location.search.includes('fair_id')) {
    window.location.href = window.location.pathname + fairParam;
}

// Rest of JavaScript wrapped in DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    const collapse = document.getElementById('instructionsCollapse');
    const toggleBtn = collapse.previousElementSibling.querySelector('button');
    const toggleIcon = toggleBtn.querySelector('i');
    const toggleText = toggleBtn.querySelector('.instructions-toggle-text');
    
    // Load saved state
    const isCollapsed = localStorage.getItem('instructionsCollapsed') === 'true';
    if (isCollapsed) {
        collapse.classList.remove('show');
        toggleIcon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        toggleText.textContent = 'Show Instructions';
    }

    collapse.addEventListener('hide.bs.collapse', function () {
        toggleIcon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        toggleText.textContent = 'Show Instructions';
        localStorage.setItem('instructionsCollapsed', 'true');
    });

    collapse.addEventListener('show.bs.collapse', function () {
        toggleIcon.classList.replace('bi-chevron-down', 'bi-chevron-up');
        toggleText.textContent = 'Hide Instructions';
        localStorage.setItem('instructionsCollapsed', 'false');
    });

    const viewModeBanner = document.getElementById('viewModeBanner');
    const exitViewModeBtn = document.getElementById('exitViewMode');

    if (exitViewModeBtn) {
        exitViewModeBtn.addEventListener('click', function() {
            localStorage.removeItem('viewFairId');
            localStorage.removeItem('viewFairName');
            // Remove fair_id from URL before reloading
            window.location.href = window.location.pathname;
        });
    }
});
</script>
{% endblock %}

{% block page_content %}
{% include 'partials/view_mode_banner.html' %}
{% if no_fair %}
    <div class="alert alert-warning">
        <h4><i class="bi bi-exclamation-triangle"></i> No Fair Currently Set Up</h4>
        {% if moderator %}
            <p>No fair has been created yet. Please create a fair first.</p>
            <a href="create_fair" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Fair
            </a>
        {% else %}
            <p>No fair is currently set up. Please contact an administrator.</p>
        {% endif %}
    </div>
{% else %}

    {% if not moderator %}{% if registrationOpen %}
        <div class="mb-3">
            <a href="submission/add/" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> New Submission
            </a>
        </div>
    {% endif %}{% endif %}

    <!-- Add Filter Button for Mobile -->
    <button class="btn btn-primary rounded-circle mobile-filter-btn shadow" data-bs-toggle="modal" data-bs-target="#filterModal">
        <i class="bi bi-funnel"></i>
    </button>

    <!-- Filter Modal -->
    <div class="modal fade filter-modal" id="filterModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-funnel me-2"></i>Filter Submissions
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- User Search -->
                    <div class="mb-3">
                        <label class="form-label">Search Users</label>
                        <input type="text" id="mobileUserSearch" class="form-control" placeholder="Search by name, email, or organization...">
                    </div>

                    <!-- Title Search -->
                    <div class="mb-3">
                        <label class="form-label">Search Titles</label>
                        <input type="text" id="mobileTitleSearch" class="form-control" placeholder="Search titles...">
                    </div>

                    <!-- Category Filter -->
                    <div class="mb-3">
                        <label class="form-label">Categories</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input mobile-category-checkbox" value="" id="mobileAllCategories">
                                <label class="form-check-label" for="mobileAllCategories">All Categories</label>
                            </div>
                            <div id="mobileCategoryCheckboxes">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Grade Range Filter -->
                    <div class="mb-3">
                        <label class="form-label">Grade Ranges</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input mobile-grade-checkbox" value="" id="mobileAllGrades">
                                <label class="form-check-label" for="mobileAllGrades">All Grades</label>
                            </div>
                            <div id="mobileGradeCheckboxes">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Submission Type Filter -->
                    <div class="mb-3">
                        <label class="form-label">Submission Types</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input mobile-type-checkbox" value="" id="mobileAllTypes">
                                <label class="form-check-label" for="mobileAllTypes">All Types</label>
                            </div>
                            <div id="mobileTypeCheckboxes">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Group Search -->
                    <div class="mb-3">
                        <label class="form-label">Search Groups</label>
                        <input type="text" id="mobileGroupSearch" class="form-control" placeholder="Search presenting groups...">
                    </div>

                    <!-- Status Filter -->
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input mobile-status-checkbox" value="" id="mobileAllStatuses">
                                <label class="form-check-label" for="mobileAllStatuses">All Statuses</label>
                            </div>
                            <div id="mobileStatusCheckboxes">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="applyMobileFilters">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover small submission-table mb-0">
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Delete Submission Modal -->
    <div class="modal fade" id="deleteSubmissionModal" tabindex="-1" aria-labelledby="deleteSubmissionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteSubmissionModalLabel">Delete Submission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteSubmissionMessage"></p>
                    <div class="alert alert-danger" id="deleteSubmissionError" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteSubmissionBtn">Delete Submission</button>
                </div>
            </div>
        </div>
    </div>

{% endif %}

<div id="app-data" 
    data-grade-ranges='{{ gradeRanges|safe }}'
    data-performance-types='{{ performanceTypes|safe }}'
    data-performance-status='{{ performanceStatus|safe }}'
    data-categories='{{ categories|safe }}'>
</div>

<div class="loading-spinner" id="tableLoader" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2 text-muted">Loading submissions...</div>
</div>

<style>
    .dropdown-toggle.btn {
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dropdown-menu {
        max-height: 300px;
        overflow-y: auto;
        transform: none !important;
        top: auto !important;
        z-index: 1000;
        background-color: white;
    }
    
    .dropdown-item {
        cursor: pointer;
        padding: .25rem .5rem;
    }

    .table-responsive {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        min-height: 400px;
    }

    .sort-btn {
        cursor: pointer;
    }

    .sort-btn:hover {
        background-color: rgba(0,0,0,.05);
    }

    .stealth {
        text-decoration: none;
    }

    .overflow-wrap {
        max-width: 200px;
        overflow-wrap: break-word;
        word-wrap: break-word;
    }

    .nowrap {
        white-space: nowrap;
    }

    .clickable-row {
        cursor: pointer;
    }

    .clickable-row:hover {
        background-color: rgba(0,0,0,.06) !important;
    }

    .action-buttons {
        position: relative;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 1050;
    }

    .table-responsive {
        position: relative;
        min-height: 400px;
    }

    /* Optional: Add fade effect to table while loading */
    .table-loading {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Update these styles */
    .filters-wrapper {
        width: 100%;
        margin-bottom: 1rem;
        overflow: visible !important;
    }

    .filters-container {
        width: 100%;
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        overflow: visible !important;
    }

    .filters-row {
        width: 100%;
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        overflow: visible !important;
    }

    .filter-col {
        flex: 1;
        min-width: 0;
        position: relative;
        overflow: visible !important;
    }

    /* Ensure dropdowns can position absolutely relative to their button */
    .filter-col .dropdown {
        position: relative;
        width: 100%;
    }

    /* Make sure dropdown menus can expand outside their containers */
    .filter-col .dropdown-menu {
        position: absolute;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Add this to ensure filters stay within table bounds */
    .table-container {
        position: relative;
    }

    .filters-wrapper {
        position: sticky;
        left: 0;
        background-color: var(--bs-body-bg);
        z-index: 1;
    }

    /* Hide filter button by default (desktop view) */
    .mobile-filter-btn {
        display: none;
    }

    @media (max-width: 768px) {
        /* Hide desktop filters */
        .filters-wrapper {
            display: none;
        }

        /* Show filter button */
        .mobile-filter-btn {
            display: block;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1030;
        }
    }
</style>

<script>
  // Get all data from the div using dataset
  const appData = document.getElementById('app-data').dataset;
//   console.log('Raw data from dataset:', appData);

  // Parse each piece individually
  const gradeRanges = JSON.parse(appData.gradeRanges || '{}');
  const performanceTypes = JSON.parse(appData.performanceTypes || '{}');
  const performanceStatus = JSON.parse(appData.performanceStatus || '{}');
  const categories = JSON.parse(appData.categories || '[]');

  console.log('Parsed data:', {
    gradeRanges,
    performanceTypes,
    performanceStatus,
    categories
  });

  const table = document.querySelector('.submission-table');
  const moderatorText = "{{ moderator }}"
  const moderator = moderatorText == 'True'
  const registrationOpenText = "{{ registrationOpen }}"
  const registrationOpen = registrationOpenText == 'True'

  class App {
    tableObjects
    tableHeader = `
    <thead>
        <tr>
            <th class="sort-btn" data-field="user.first_name"><div class="d-flex align-items-center">User<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="title"><div class="d-flex align-items-center">Title<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="category.name"><div class="d-flex align-items-center">Category<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="grade_range"><div class="d-flex align-items-center">Grade<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="submission_type"><div class="d-flex align-items-center">Submission type<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="group"><div class="d-flex align-items-center">Presenting Group<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="status_display"><div class="d-flex align-items-center">Status<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:none;"></i></span></div></th>
            <th class="sort-btn" data-field="updated"><div class="d-flex align-items-center">Action<span class="d-flex flex-column"><i class="bi bi-caret-up-fill sort-caret" style="display:none;"></i><i class="bi bi-caret-down-fill sort-caret" style="display:block;"></i></span></div></th>
        </tr>
    </thead>
    <tbody>
    </tbody>
`
    tableBody
    activeValue
    activeEditButton
    sort = { field: 'updated', direction: 'desc'};

    constructor() {
        // Add filter data properties
        this.gradeRanges = gradeRanges;
        this.performanceTypes = performanceTypes;
        this.performanceStatus = performanceStatus;
        this.categories = categories || [];
        this.lastKnownColumnWidths = []; // Add this to store column widths

        // Create filter row before setting up the table
        this._createFilterRow();
        this._initializeFilterElements();

        // Your existing constructor code
        document.addEventListener('DOMContentLoaded', () => {
            this._loadTable(true, true);
        });

        this._clickSortCaret = this._clickSortCaret.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.sort-btn')) {
                    this._clickSortCaret(e);
                }
            });
        });

        this._clickApproveSubmission = this._clickApproveSubmission.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.submission-approve')) {
                    this._clickApproveSubmission(e);
                }
            });
        });

        this._clickUnapproveSubmission = this._clickUnapproveSubmission.bind(this);
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.submission-unapprove')) {
                    this._clickUnapproveSubmission(e);
                }
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.submission-retract')) {
                    this._clickUnapproveSubmission(e);
                }
            });
        });

        // Add click handler for rows
        document.addEventListener('click', (e) => {
            const row = e.target.closest('.clickable-row');
            if (row && !e.target.closest('.action-buttons')) {
                window.location.href = row.dataset.href;
            }
        });

        // Add debounce function
        this._debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // Debounce the filter application
        this._debouncedApplyFilters = this._debounce(() => {
            this._applyFilters();
        }, 150);

        // Debounce the width adjustment
        this._debouncedAdjustWidths = this._debounce(() => {
            this._adjustFilterWidths();
        }, 250);

        // Add resize observer with debounced callback
        const resizeObserver = new ResizeObserver(() => {
            this._debouncedAdjustWidths();
        });

        // Observe both the table and its container
        const table = document.querySelector('.submission-table');
        const tableContainer = document.querySelector('.table-responsive');
        if (table && tableContainer) {
            resizeObserver.observe(table);
            resizeObserver.observe(tableContainer);
        }

        // Simplified mutation observer that only triggers on important changes
        const mutationObserver = new MutationObserver((mutations) => {
            const shouldAdjust = mutations.some(mutation => {
                return mutation.type === 'childList' && 
                       (mutation.target.tagName === 'THEAD' || 
                        (mutation.target.tagName === 'TBODY' && mutation.addedNodes.length > 0));
            });
            
            if (shouldAdjust) {
                this._debouncedAdjustWidths();
            }
        });

        if (table) {
            mutationObserver.observe(table, {
                childList: true,
                subtree: true,
                characterData: false,
                attributes: false
            });
        }

        this._initializeSubmissionDeleteModal();

        // Initialize mobile filter modal
        this._initializeMobileFilters();
    }

    _getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    _getSubmissions(){
        let user_param;
        if (moderator) {
            user_param = ""
        } else {
            const user_id = "{{ currentUser.id }}";
            user_param = `?user_id=${user_id}`
        }

        const fairId = localStorage.getItem('viewFairId');
        const fairParam = fairId ? `?fair_id=${fairId}` : '';
        const headers = { 'Content-Type': 'application/json' };
        return fetch(`/api/submission/${user_param}${fairParam}`, { headers, })
            .then(res => res.json())
            .then(data => {
                this.tableObjects = data
            });
    }

    _getSubmission(submission_id){

        const headers = { 'Content-Type': 'application/json' };
        return fetch(`/api/submission/${submission_id}`, { headers, })
            .then(res => res.json())
            .then(data => {
                return data;
            });

    }

    async _loadTable(doFetch, sort, { field = 'updated', direction = 'desc' } = {}) {
        const loader = document.getElementById('tableLoader');
        const tableBody = document.querySelector('.submission-table tbody');
        
        try {
            loader.style.display = 'block';
            tableBody.classList.add('table-loading');
            
            if (doFetch == true) {
                await this._getSubmissions()
            }
            if (!sort) {
                field = this.sort.field;
                direction = this.sort.direction;
            }

            // console.log(field, direction)
                // Sort tableObjects if a field is specified
                if (field) {
                    this.tableObjects.sort((a, b) => {
                        // Check if the first index of the field exists in a or b
                        const firstIndex = field.split('.')[0];
                        if (!(firstIndex in a)) return 1;
                        if (!(firstIndex in b)) return -1;

                        // Split the field string into an array and use reduce to access the nested property
                        let aField = field.split('.').reduce((o, i) => (o ? o[i] : undefined), a);
                        let bField = field.split('.').reduce((o, i) => (o ? o[i] : undefined), b);

                        // If aField or bField is undefined, sort it last
                        if (aField === undefined) return 1;
                        if (bField === undefined) return -1;

                        // Convert fields to lowercase if they are strings
                        if (typeof aField === 'string') aField = aField.toLowerCase();
                        if (typeof bField === 'string') bField = bField.toLowerCase();

                        if (aField < bField) return direction === 'asc' ? -1 : 1;
                        if (aField > bField) return direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

            table.innerHTML = this.tableHeader
            this.tableBody = document.querySelector('.submission-table tbody');
            this.tableObjects.forEach((tableObject) => {
                const html = this._buildRowHtml(tableObject);
                // const row = this.tableBody.insertRow();
                // row.innerHTML = html
                this.tableBody.insertAdjacentHTML('beforeend', html);
            });

            this._initializeSubmissionDeleteButtons();

            // Add this after table is populated
            this._adjustFilterWidths();
            // // Add a small delay to ensure table is fully rendered
            // setTimeout(() => {
            //     this._adjustFilterWidths();
            // }, 100);



        } finally {
            loader.style.display = 'none';
            tableBody.classList.remove('table-loading');
        }
    }

    _buildRowHtml(tableObject) {
        const viewFairId = localStorage.getItem('viewFairId');

        let category;
        let submission_type;
        let group;
        let detail_link;
        let edit_link;
        // console.log(tableObject)
        // console.log(tableObject.category)
        category = tableObject.category.name;
        submission_type = tableObject.submission_type;
        group = tableObject.group;
        detail_link = `/submission/${tableObject.id}/`;
        edit_link = detail_link + 'edit/';

        let approveTooltip;
        let approveButton
        if ( tableObject.status=="submitted" ) {
            approveTooltip = ' title="Approve"'
            approveButton = `{% bs_icon 'check-square-fill' extra_classes='submission-approve' color='green' %}`
        } else {
            approveTooltip = ''
            approveButton = `{% bs_icon 'check-square-fill' extra_classes='submission-approve' color='grey' %}`
        }

        let unapproveTooltip;
        let unapproveButton;
        if ( tableObject.status=="submitted" || tableObject.status=="approved") {
            unapproveTooltip = ' title="Unapprove"'
            unapproveButton = `{% bs_icon 'x-square-fill' extra_classes="submission-unapprove" color='darkred' %}`
        } else {
            unapproveTooltip = ''
            unapproveButton = `{% bs_icon 'x-square-fill' extra_classes="submission-unapprove" color='grey' %}`
        }
        
        let editTooltip;
        let editButton;
        let editHref;
        if ( registrationOpen ) {
            if ( tableObject.status=="in_progress" ) {
                editHref = edit_link;
                editTooltip = ' title="Edit"'
                editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='blue' %}`
            } else {
                if (moderator) {
                    editHref = 'javascript:void(0)';
                    editTooltip = ''
                    editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='grey' %}`
                } else {
                    if ( tableObject.status=="submitted" ) {
                        editHref = 'javascript:void(0)';
                        editTooltip = ' title="Retract submission to continue editing"'
                        editButton = `{% bs_icon 'arrow-counterclockwise' extra_classes="submission-retract" color='tomato' %}`
                    } else {
                        editHref = 'javascript:void(0)';
                        editTooltip = ''
                        editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='grey' %}`
                    }
                }

            }
        } else {
            editHref = 'javascript:void(0)';
            editTooltip = ''
            editButton = `{% bs_icon 'pencil-square' extra_classes="submission-edit" color='grey' %}`
        }



        const html = `
        <tr data-id="${tableObject.id}" data-status="${tableObject.status}" class="clickable-row" data-href="${detail_link}">
            <td>
                ${moderator ? `<a href='/user/${tableObject.user.id}'>` : ``}
                    ${(tableObject.user.first_name + ' ' + tableObject.user.last_name).substring(0, 30)}<br />
                ${moderator ? `</a>` : ``}
                    ${(tableObject.user.organization || '').substring(0, 30)}<br />
                    ${(tableObject.user.email).substring(0, 30)}

            </td>
            <td class="overflow-wrap">
                ${tableObject.title}
            </td>
            <td>
                ${category}
            </td>
            <td>
                ${tableObject.grade_range_display}
            </td>
            <td>
                ${submission_type}
            </td>
            <td>
                ${group}
            </td>
            <td>
                ${tableObject.status_display}
            </td>
            <td class="action-buttons">
                ${!viewFairId ? `
                    <span class="d-inline-flex align-items-center nowrap">
                        ${moderator ? `<span>
                                <a class="stealth" href="javascript:void(0)"${approveTooltip}>
                                    ${approveButton}
                                </a>
                        </span>
                        <span>
                                <a class="stealth" href="javascript:void(0)"${unapproveTooltip}>
                                    ${unapproveButton}
                                </a>
                        </span>
                        <span> | </span>` : ``}
                        <span>
                                <a class="stealth" href="${detail_link}" title="Info">
                                    {% bs_icon 'info-circle-fill' extra_classes="submission-detail" %}
                                </a>
                        </span>
                        <span>
                                <a class="stealth" href="${editHref}"${editTooltip}>
                                    ${editButton}
                                </a>
                        </span>
                        ${moderator ? `<span>
                                <a class="stealth submission-delete" href="javascript:void(0)" title="Delete">
                                    {% bs_icon 'trash3-fill' color='red' %}
                                </a>
                        </span>` : ``}
                    </span>
                ` : `
                    <span class="d-inline-flex align-items-center nowrap">
                        <span>
                            <a class="stealth" href="${detail_link}" title="Info">
                                {% bs_icon 'info-circle-fill' extra_classes="submission-detail" %}
                            </a>
                        </span>
                    </span>
                `}
            </td>
        </tr>
  `;
        return html
    }


    async _clickSortCaret(e) {
        const target = e.target;
        let thElement;

        if (target.tagName.toLowerCase() === 'th') {
            thElement = target;
        } else {
            thElement = target.closest('th');
        }

        const field = thElement.dataset.field;
        let direction;
        if ( field == this.sort.field ) {
            direction = this.sort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            direction = 'asc';
        }
        await this._loadTable(false, true, { field:field, direction:direction });
        
        const carets = document.querySelectorAll('.sort-caret');
        await carets.forEach(caret => caret.style.display = 'none');
        const thisColumn = document.querySelector(`.submission-table th[data-field="${field}"]`);
        if ( direction == 'asc' ) {
            const thisCaret = thisColumn.querySelector('.bi-caret-up-fill');
            thisCaret.style.display = 'block';
        } else {
            const thisCaret = thisColumn.querySelector('.bi-caret-down-fill');
            thisCaret.style.display = 'block';
        }

        this.sort = { field, direction };
    }


    async _clickApproveSubmission(e) {
        const row = e.target.closest('tr');
        const submission_id = row.dataset.id;
        const status = row.dataset.status;
        if (status == "submitted") {
            await this._updateSubmission(submission_id, 'approved');

            await this._loadTable(true, true, { field: this.sort.field, direction: this.sort.direction });
        }
    }

    async _clickUnapproveSubmission(e) {
        const row = e.target.closest('tr');
        const submission_id = row.dataset.id;
        const status = row.dataset.status;
        if (status == "submitted" || status == "approved") {
            await this._updateSubmissionPartStatus(submission_id, 'review_status', 'pending')
            await this._updateSubmission(submission_id, 'in_progress');
            await this._loadTable(true, true, { field: this.sort.field, direction: this.sort.direction });
        }
    }

    _updateSubmission(submission_id, status) {
        const fairId = localStorage.getItem('viewFairId');
        const fairParam = fairId ? `?fair_id=${fairId}` : '';
        const body = JSON.stringify({
                status: status,});
            const csrftoken = this._getCookie('csrftoken');
            const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
            return fetch(`/api/submission-update/${submission_id}/${fairParam}`, {
                method: 'PATCH',
                headers,
                body: body,
            })
            .then(res => {
                res.json()
                // console.log(res)
            })
            .then(data => {
                console.log('Modified submission:', data);
                // Handle any further actions after modifying the submission
            })
            .catch(error => {
                console.error('Error modifying submission:', error);
                // Handle errors, if any
            });
    }

    _updateSubmissionPartStatus(submission_id, field, status) {

        const body = JSON.stringify({
            [field]: status});
        const csrftoken = this._getCookie('csrftoken');
        const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
        return fetch(`/api/submission-update/${submission_id}/`, {
            method: 'PATCH',
            headers,
            body: body,
        })
        .then(res => {
            res.json()
            console.log(res)
        })
        .then(data => {
            console.log('Modified submission status:', data);
            // Handle any further actions after modifying the submission
        })
        .catch(error => {
            console.error('Error modifying submission status:', error);
            // Handle errors, if any
        });
    }

    _createFilterRow() {
        const filterRow = `
            <div class="filters-wrapper">
                <div class="filters-container">
                    <div class="filters-row">
                        <!-- User Search -->
                        <div class="filter-col">
                            <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="Search users...">
                        </div>
                        <!-- Title Search -->
                        <div class="filter-col">
                            <input type="text" id="titleSearchInput" class="form-control form-control-sm" placeholder="Search titles...">
                        </div>
                        <!-- Category Filter -->
                        <div class="filter-col">
                            <div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button" id="categoryDropdown" data-bs-toggle="dropdown">
                                    Category
                                </button>
                                <div class="dropdown-menu">
                                    <label class="dropdown-item">
                                        <input type="checkbox" value="" class="category-checkbox me-2"> All
                                    </label>
                                    ${this.categories.map(cat => `
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="${cat.id}" class="category-checkbox me-2"> ${cat.name}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <!-- Grade Range Filter -->
                        <div class="filter-col">
                            <div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button" id="gradeDropdown" data-bs-toggle="dropdown">
                                    Grade
                                </button>
                                <div class="dropdown-menu">
                                    <label class="dropdown-item">
                                        <input type="checkbox" value="" class="grade-checkbox me-2"> All
                                    </label>
                                    ${Object.entries(this.gradeRanges).map(([id, name]) => `
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="${id}" class="grade-checkbox me-2"> ${name}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <!-- Submission Type Filter -->
                        <div class="filter-col">
                            <div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button" id="typeDropdown" data-bs-toggle="dropdown">
                                    Type
                                </button>
                                <div class="dropdown-menu">
                                    <label class="dropdown-item">
                                        <input type="checkbox" value="" class="type-checkbox me-2"> All
                                    </label>
                                    ${Object.entries(this.performanceTypes).map(([id, name]) => `
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="${id}" class="type-checkbox me-2"> ${name}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <!-- Group Search -->
                        <div class="filter-col">
                            <input type="text" id="groupSearchInput" class="form-control form-control-sm" placeholder="Search groups...">
                        </div>
                        <!-- Status Filter -->
                        <div class="filter-col">
                            <div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button" id="statusDropdown" data-bs-toggle="dropdown">
                                    Status
                                </button>
                                <div class="dropdown-menu">
                                    <label class="dropdown-item">
                                        <input type="checkbox" value="" class="status-checkbox me-2"> All
                                    </label>
                                    ${Object.entries(this.performanceStatus).map(([id, name]) => `
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="${id}" class="status-checkbox me-2"> ${name}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <!-- Empty column for action column alignment -->
                        <div class="filter-col"></div>
                    </div>
                </div>
            </div>
        `;
        
        const table = document.querySelector('.submission-table');
        table.insertAdjacentHTML('beforebegin', filterRow);
    }

    _initializeFilterElements() {
        // Get references to filter elements
        this.userSearchInput = document.getElementById('userSearchInput');
        this.titleSearchInput = document.getElementById('titleSearchInput');
        this.groupSearchInput = document.getElementById('groupSearchInput');
        this.categoryCheckboxes = document.querySelectorAll('.category-checkbox');
        this.gradeCheckboxes = document.querySelectorAll('.grade-checkbox');
        this.typeCheckboxes = document.querySelectorAll('.type-checkbox');
        this.statusCheckboxes = document.querySelectorAll('.status-checkbox');

        // Add debounced filter event listeners
        this.userSearchInput.addEventListener('input', () => this._debouncedApplyFilters());
        this.titleSearchInput.addEventListener('input', () => this._debouncedApplyFilters());
        this.groupSearchInput.addEventListener('input', () => this._debouncedApplyFilters());

        // Initialize checkboxes
        [
            {checkboxes: this.categoryCheckboxes, dropdown: document.getElementById('categoryDropdown'), text: 'Category'},
            {checkboxes: this.gradeCheckboxes, dropdown: document.getElementById('gradeDropdown'), text: 'Grade'},
            {checkboxes: this.typeCheckboxes, dropdown: document.getElementById('typeDropdown'), text: 'Type'},
            {checkboxes: this.statusCheckboxes, dropdown: document.getElementById('statusDropdown'), text: 'Status'}
        ].forEach(({checkboxes, dropdown, text}) => {
            // Set initial state
            const allCheckbox = Array.from(checkboxes).find(cb => cb.value === '');
            if (allCheckbox) allCheckbox.checked = true;

            // Add change listeners
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    this._handleCheckboxSelection(checkbox, checkboxes, dropdown, text);
                });
            });
        });

        // Prevent dropdowns from closing when clicking checkboxes
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.addEventListener('click', e => e.stopPropagation());
        });
    }

    _handleCheckboxSelection(checkbox, checkboxes, dropdown, defaultText) {
        if (checkbox.value === '') {
            // If "All" is selected, uncheck others
            checkboxes.forEach(cb => {
                if (cb !== checkbox) cb.checked = false;
            });
        } else {
            // If specific item is selected, uncheck "All"
            const allCheckbox = Array.from(checkboxes).find(cb => cb.value === '');
            if (allCheckbox) allCheckbox.checked = false;

            // If no specific items are checked, check "All"
            const anyChecked = Array.from(checkboxes).some(cb => cb.value !== '' && cb.checked);
            if (!anyChecked && allCheckbox) {
                allCheckbox.checked = true;
            }
        }

        this._updateDropdownText(checkboxes, dropdown, defaultText);
        this._applyFilters();
    }

    _updateDropdownText(checkboxes, dropdownButton, defaultText) {
        const checked = Array.from(checkboxes)
            .filter(cb => cb.checked && cb.value !== '')
            .map(cb => cb.parentElement.textContent.trim());
        
        dropdownButton.textContent = checked.length ? checked.join(', ') : defaultText;
    }

    _applyFilters() {
        const userSearch = this.userSearchInput.value.toLowerCase();
        const titleSearch = this.titleSearchInput.value.toLowerCase();
        const groupSearch = this.groupSearchInput.value.toLowerCase();

        const selectedCategories = Array.from(this.categoryCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const selectedGrades = Array.from(this.gradeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const selectedTypes = Array.from(this.typeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const selectedStatuses = Array.from(this.statusCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        let hasVisibleRows = false;
        const firstVisibleRow = document.querySelector('.submission-table tbody tr:not([style*="display: none"])');
        
        // Store current column widths if we have visible rows
        if (firstVisibleRow) {
            this.lastKnownColumnWidths = Array.from(firstVisibleRow.cells).map(cell => 
                cell.getBoundingClientRect().width
            );
        }
        
        this.tableObjects.forEach(submission => {
            const row = document.querySelector(`tr[data-id="${submission.id}"]`);
            if (!row) return;

            const userText = `${submission.user.first_name} ${submission.user.last_name} ${submission.user.organization} ${submission.user.email}`.toLowerCase();
            const matchesUser = !userSearch || userText.includes(userSearch);
            const matchesTitle = !titleSearch || submission.title.toLowerCase().includes(titleSearch);
            const matchesGroup = !groupSearch || (submission.group || '').toLowerCase().includes(groupSearch);
            const matchesCategory = selectedCategories.includes('') || selectedCategories.includes(submission.category.id.toString());
            const matchesGrade = selectedGrades.includes('') || selectedGrades.includes(submission.grade_range);
            const matchesType = selectedTypes.includes('') || selectedTypes.includes(submission.submission_type);
            const matchesStatus = selectedStatuses.includes('') || selectedStatuses.includes(submission.status);

            const isVisible = matchesUser && matchesTitle && matchesGroup && 
                            matchesCategory && matchesGrade && matchesType && 
                            matchesStatus;
            
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) hasVisibleRows = true;
        });

        // If no rows are visible, add a "no results" row that maintains the table structure
        const noResultsRow = document.querySelector('.no-results-row');
        if (!hasVisibleRows) {
            if (!noResultsRow) {
                const tbody = document.querySelector('.submission-table tbody');
                const colCount = document.querySelectorAll('.submission-table th').length;
                const newRow = document.createElement('tr');
                newRow.className = 'no-results-row';
                
                // Create individual cells with preserved widths
                const cellsHtml = this.lastKnownColumnWidths.map((width, index) => {
                    if (index === 0) {
                        // First cell spans all columns and contains the message
                        return `<td colspan="${colCount}" class="text-center py-4" style="min-width: ${width}px;">
                            <div class="text-muted">No matching results found</div>
                        </td>`;
                    }
                    return ''; // Other cells are not needed due to colspan
                }).join('');
                
                newRow.innerHTML = cellsHtml;
                tbody.appendChild(newRow);

                // Also maintain header widths
                const headerCells = document.querySelectorAll('.submission-table th');
                headerCells.forEach((cell, index) => {
                    if (this.lastKnownColumnWidths[index]) {
                        cell.style.width = `${this.lastKnownColumnWidths[index]}px`;
                        cell.style.minWidth = `${this.lastKnownColumnWidths[index]}px`;
                    }
                });
            } else {
                noResultsRow.style.display = '';
            }
        } else if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
    }

    _adjustFilterWidths() {
        // Cache DOM queries
        const headerCells = document.querySelectorAll('.submission-table th');
        const filterCols = document.querySelectorAll('.filter-col');
        const tableBody = document.querySelector('.submission-table tbody');
        const firstRow = tableBody?.rows[0];

        if (!firstRow || !headerCells.length || !filterCols.length) return;

        // Remove existing inline styles
        filterCols.forEach(col => {
            col.style.width = '';
            col.style.margin = '0';
        });

        // Use a single requestAnimationFrame
        requestAnimationFrame(() => {
            headerCells.forEach((headerCell, index) => {
                if (filterCols[index] && firstRow.cells[index]) {
                    const headerWidth = headerCell.getBoundingClientRect().width;
                    const contentWidth = firstRow.cells[index].getBoundingClientRect().width;
                    const width = Math.max(headerWidth, contentWidth);
                    const adjustedWidth = width - 8;
                    
                    filterCols[index].style.width = `${adjustedWidth}px`;
                    filterCols[index].style.minWidth = `${adjustedWidth}px`;
                }
            });
        });
    }

    _initializeSubmissionDeleteModal() {
        this.submissionDeleteModal = new bootstrap.Modal(document.getElementById('deleteSubmissionModal'));
        this.deleteSubmissionMessage = document.getElementById('deleteSubmissionMessage');
        this.deleteSubmissionError = document.getElementById('deleteSubmissionError');
        this.confirmDeleteSubmissionBtn = document.getElementById('confirmDeleteSubmissionBtn');

        // Reset modal state when it's hidden
        document.getElementById('deleteSubmissionModal').addEventListener('hidden.bs.modal', () => {
            this.deleteSubmissionError.style.display = 'none';
            this.confirmDeleteSubmissionBtn.style.display = 'block';
            this.deleteSubmissionMessage.innerHTML = '';
        });
    }

    _initializeSubmissionDeleteButtons() {
        const deleteIcons = document.querySelectorAll('.submission-delete');
        
        deleteIcons.forEach(icon => {
            // Remove any existing event listeners
            const newIcon = icon.cloneNode(true);
            icon.parentNode.replaceChild(newIcon, icon);
            
            newIcon.addEventListener('click', (e) => {
                console.log('Delete button clicked!');
                e.preventDefault();
                e.stopPropagation();
                const row = e.target.closest('tr');
                const submissionId = row.dataset.id;
                
                this.deleteSubmissionMessage.innerHTML = 'Are you sure you want to delete this submission? This action cannot be undone.';
                this.deleteSubmissionError.style.display = 'none';
                this.confirmDeleteSubmissionBtn.style.display = 'block';
                this.confirmDeleteSubmissionBtn.onclick = () => this._handleSubmissionDelete(submissionId, row);
                this.submissionDeleteModal.show();
            });
        });
    }

    async _handleSubmissionDelete(submissionId, row) {
        try {
            const response = await fetch(`/api/submission/${submissionId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': this._getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to delete submission');
            }

            // Hide the modal
            this.submissionDeleteModal.hide();

            // Remove the submission row from the table and reload
            await this._loadTable(true, false);

        } catch (error) {
            console.error('Error deleting submission:', error);
            this.deleteSubmissionError.textContent = error.message || 'Failed to delete submission';
            this.deleteSubmissionError.style.display = 'block';
            this.confirmDeleteSubmissionBtn.style.display = 'none';
        }
    }

    _initializeMobileFilters() {
        // Cache mobile filter elements
        this.mobileUserSearch = document.getElementById('mobileUserSearch');
        this.mobileTitleSearch = document.getElementById('mobileTitleSearch');
        this.mobileGroupSearch = document.getElementById('mobileGroupSearch');
        this.mobileCategoryCheckboxes = document.querySelectorAll('.mobile-category-checkbox');
        this.mobileGradeCheckboxes = document.querySelectorAll('.mobile-grade-checkbox');
        this.mobileTypeCheckboxes = document.querySelectorAll('.mobile-type-checkbox');
        this.mobileStatusCheckboxes = document.querySelectorAll('.mobile-status-checkbox');

        // Handle apply filters button click
        document.getElementById('applyMobileFilters').addEventListener('click', () => {
            this._applyMobileFilters();
        });

        // Sync desktop and mobile filter states
        const filterModal = document.getElementById('filterModal');
        filterModal.addEventListener('show.bs.modal', () => {
            this._syncFiltersToModal();
        });

        // Initialize mobile checkboxes
        const mobileAllCategories = document.getElementById('mobileAllCategories');
        if (mobileAllCategories) {
            mobileAllCategories.checked = true;
            this.mobileCategoryCheckboxes.forEach(cb => {
                if (cb !== mobileAllCategories) {
                    cb.checked = false;
                }
            });
        }

        // Populate category checkboxes
        const categoryContainer = document.getElementById('mobileCategoryCheckboxes');
        if (categoryContainer) {
            const categoryHTML = categories.map(category => `
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input mobile-category-checkbox" 
                           value="${category.id}" 
                           id="mobileCat${category.id}">
                    <label class="form-check-label" for="mobileCat${category.id}">
                        ${category.name}
                    </label>
                </div>
            `).join('');
            categoryContainer.innerHTML = categoryHTML;
        }

        // Re-query checkboxes after populating
        this.mobileCategoryCheckboxes = document.querySelectorAll('.mobile-category-checkbox');

        // Populate grade checkboxes
        const gradeContainer = document.getElementById('mobileGradeCheckboxes');
        if (gradeContainer) {
            const gradeHTML = Object.entries(gradeRanges).map(([id, name]) => `
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input mobile-grade-checkbox" 
                           value="${id}" 
                           id="mobileGrade${id}">
                    <label class="form-check-label" for="mobileGrade${id}">
                        ${name}
                    </label>
                </div>
            `).join('');
            gradeContainer.innerHTML = gradeHTML;
        }

        // Re-query checkboxes after populating
        this.mobileGradeCheckboxes = document.querySelectorAll('.mobile-grade-checkbox');

        // Populate type checkboxes
        const typeContainer = document.getElementById('mobileTypeCheckboxes');
        if (typeContainer) {
            const typeHTML = Object.entries(performanceTypes).map(([id, name]) => `
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input mobile-type-checkbox" 
                           value="${id}" 
                           id="mobileType${id}">
                    <label class="form-check-label" for="mobileType${id}">
                        ${name}
                    </label>
                </div>
            `).join('');
            typeContainer.innerHTML = typeHTML;
        }

        // Re-query checkboxes after populating
        this.mobileTypeCheckboxes = document.querySelectorAll('.mobile-type-checkbox');

        // Populate status checkboxes
        const statusContainer = document.getElementById('mobileStatusCheckboxes');
        if (statusContainer) {
            const statusHTML = Object.entries(performanceStatus).map(([id, name]) => `
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input mobile-status-checkbox" 
                           value="${id}" 
                           id="mobileStatus${id}">
                    <label class="form-check-label" for="mobileStatus${id}">
                        ${name}
                    </label>
                </div>
            `).join('');
            statusContainer.innerHTML = statusHTML;
        }

        // Re-query checkboxes after populating
        this.mobileStatusCheckboxes = document.querySelectorAll('.mobile-status-checkbox');

        // Add checkbox change handlers
        [
            {checkboxes: this.mobileCategoryCheckboxes, name: 'category'},
            {checkboxes: this.mobileGradeCheckboxes, name: 'grade'},
            {checkboxes: this.mobileTypeCheckboxes, name: 'type'},
            {checkboxes: this.mobileStatusCheckboxes, name: 'status'}
        ].forEach(({checkboxes, name}) => {
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    this._handleMobileCheckboxSelection(checkbox, checkboxes);
                });
            });
        });
    }

    _syncFiltersToModal() {
        // Sync text inputs
        this.mobileUserSearch.value = this.userSearchInput.value;
        this.mobileTitleSearch.value = this.titleSearchInput.value;
        this.mobileGroupSearch.value = this.groupSearchInput.value;

        // For categories, sync with desktop state
        const desktopCategoryChecked = Array.from(this.categoryCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        this.mobileCategoryCheckboxes.forEach(cb => {
            if (cb.value === '') {
                // "All" checkbox
                cb.checked = desktopCategoryChecked.includes('');
            } else {
                cb.checked = desktopCategoryChecked.includes(cb.value);
            }
        });

        // Sync other checkboxes
        this._syncCheckboxesFromDesktop(this.gradeCheckboxes, this.mobileGradeCheckboxes);
        this._syncCheckboxesFromDesktop(this.typeCheckboxes, this.mobileTypeCheckboxes);
        this._syncCheckboxesFromDesktop(this.statusCheckboxes, this.mobileStatusCheckboxes);
    }

    _syncCheckboxesFromDesktop(desktopCheckboxes, mobileCheckboxes) {
        const selectedDesktopValues = Array.from(desktopCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        const hasSelectedValues = selectedDesktopValues.some(v => v !== '');
        mobileCheckboxes.forEach(cb => {
            if (cb.value === '') {
                cb.checked = !hasSelectedValues;
            } else {
                cb.checked = selectedDesktopValues.includes(cb.value);
            }
        });
    }

    _applyMobileFilters() {
        // Get selected values
        const selectedCategories = Array.from(this.mobileCategoryCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const selectedGrades = Array.from(this.mobileGradeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const selectedTypes = Array.from(this.mobileTypeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const selectedStatuses = Array.from(this.mobileStatusCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        // Update desktop filters to match
        this._syncCheckboxesFromMobile(selectedCategories, this.categoryCheckboxes);
        this._syncCheckboxesFromMobile(selectedGrades, this.gradeCheckboxes);
        this._syncCheckboxesFromMobile(selectedTypes, this.typeCheckboxes);
        this._syncCheckboxesFromMobile(selectedStatuses, this.statusCheckboxes);

        // Update text inputs
        this.userSearchInput.value = this.mobileUserSearch.value;
        this.titleSearchInput.value = this.mobileTitleSearch.value;
        this.groupSearchInput.value = this.mobileGroupSearch.value;

        // Apply filters
        this._applyFilters();

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
        modal.hide();
    }

    _syncCheckboxesFromMobile(selectedValues, desktopCheckboxes) {
        const hasSelectedValues = selectedValues.some(v => v !== '');
        desktopCheckboxes.forEach(cb => {
            if (cb.value === '') {
                cb.checked = !hasSelectedValues;
            } else {
                cb.checked = selectedValues.includes(cb.value);
            }
        });
    }

    _handleMobileCheckboxSelection(checkbox, checkboxes) {
        if (checkbox.value === '') {
            // If "All" is selected, uncheck others and check "All"
            checkboxes.forEach(cb => {
                cb.checked = (cb === checkbox);
            });
        } else {
            // If specific item is selected
            const allCheckbox = Array.from(checkboxes).find(cb => cb.value === '');
            
            // Uncheck "All"
            if (allCheckbox) {
                allCheckbox.checked = false;
            }

            // If no specific items are checked, check "All"
            const anyChecked = Array.from(checkboxes).some(cb => cb.value !== '' && cb.checked);
            if (!anyChecked && allCheckbox) {
                allCheckbox.checked = true;
                // Uncheck all other boxes
                checkboxes.forEach(cb => {
                    if (cb !== allCheckbox) {
                        cb.checked = false;
                    }
                });
            }
        }
    }

    _createFilterModal() {
        const modalHTML = `
            <!-- ... other modal content ... -->
            
            <!-- Category Filter -->
            <div class="mb-3">
                <label class="form-label">Categories</label>
                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input mobile-category-checkbox" value="" id="mobileAllCategories">
                        <label class="form-check-label" for="mobileAllCategories">All Categories</label>
                    </div>
                    <div id="mobileCategoryCheckboxes">
                        <!-- This will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Grade Range Filter -->
            <div class="mb-3">
                <label class="form-label">Grade Ranges</label>
                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input mobile-grade-checkbox" value="" id="mobileAllGrades">
                        <label class="form-check-label" for="mobileAllGrades">All Grades</label>
                    </div>
                    <div id="mobileGradeCheckboxes">
                        <!-- This will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Submission Type Filter -->
            <div class="mb-3">
                <label class="form-label">Submission Types</label>
                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input mobile-type-checkbox" value="" id="mobileAllTypes">
                        <label class="form-check-label" for="mobileAllTypes">All Types</label>
                    </div>
                    <div id="mobileTypeCheckboxes">
                        <!-- This will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Status Filter -->
            <div class="mb-3">
                <label class="form-label">Status</label>
                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input mobile-status-checkbox" value="" id="mobileAllStatuses">
                        <label class="form-check-label" for="mobileAllStatuses">All Statuses</label>
                    </div>
                    <div id="mobileStatusCheckboxes">
                        <!-- This will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        `;
        return modalHTML;
    }
  }
  const app = new App();
</script>

{% endblock %}
