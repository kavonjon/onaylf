{% extends "base.html" %}
{% load bootstrap5 %}
{% load bootstrap_icons %}

{% block title %}Programs/Schools{% endblock %}

{% block page_content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="card-title mb-0">
                        Programs/Schools
                    </h2>
                </div>

                <div class="card-body">
                    <!-- Add Organization Form -->
                    <div id="addOrgForm" class="mb-4">
                        <div class="input-group">
                            <input type="text" id="newOrgName" class="form-control" placeholder="Enter new program/school name">
                            <button class="btn btn-primary" id="addOrgBtn">
                                <i class="bi bi-plus-circle"></i> Add
                            </button>
                        </div>
                        <div id="addOrgMessage" class="alert mt-2" style="display: none;"></div>
                    </div>

                    <!-- Organizations List -->
                    <div class="list-group" id="orgList">
                        {% for org in organizations %}
                        <div class="list-group-item d-flex justify-content-between align-items-center org-item" data-id="{{ org.id }}">
                            <span class="org-name">{{ org.name }}</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-org">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-org">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reassign Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage"></p>
                <div class="mb-3">
                    <select class="form-select" id="newOrgSelect">
                        <option value="">Select a program/school...</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div id="otherOrgContainer" style="display: none;">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="otherOrgInput" placeholder="Enter new program/school name">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="addAsOrgCheckbox">
                        <label class="form-check-label" for="addAsOrgCheckbox">
                            Add as a new program/school to the list
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmDelete">Confirm</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ADD_URL = "{% url 'organization_add' %}";
    const EDIT_URL = id => `{% url 'organization_edit' pk=999 %}`.replace('999', id);
    const DELETE_URL = id => `{% url 'organization_delete' pk=999 %}`.replace('999', id);

    const addOrgForm = document.getElementById('addOrgForm');
    const newOrgName = document.getElementById('newOrgName');
    const addOrgBtn = document.getElementById('addOrgBtn');
    const addOrgMessage = document.getElementById('addOrgMessage');
    const orgList = document.getElementById('orgList');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const newOrgSelect = document.getElementById('newOrgSelect');
    const otherOrgContainer = document.getElementById('otherOrgContainer');
    const otherOrgInput = document.getElementById('otherOrgInput');
    const addAsOrgCheckbox = document.getElementById('addAsOrgCheckbox');
    
    let currentDeleteOrgId = null;

    // Add Organization
    addOrgBtn.addEventListener('click', async function() {
        const name = newOrgName.value.trim();
        if (!name) return;

        try {
            const response = await fetch(ADD_URL, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: new URLSearchParams({name}),
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            // Show success message
            addOrgMessage.textContent = 'Organization added successfully!';
            addOrgMessage.className = 'alert alert-success mt-2';
            addOrgMessage.style.display = 'block';
            setTimeout(() => addOrgMessage.style.display = 'none', 3000);

            // Create new organization element
            const newOrgHtml = createOrgElement(data);
            
            // Find the correct position to insert the new organization
            const orgItems = Array.from(orgList.children);
            const insertIndex = orgItems.findIndex(item => 
                item.querySelector('.org-name').textContent.toLowerCase() > data.name.toLowerCase()
            );

            if (insertIndex === -1) {
                // If no position found, append to the end
                orgList.insertAdjacentHTML('beforeend', newOrgHtml);
            } else {
                // Insert at the correct position
                orgItems[insertIndex].insertAdjacentHTML('beforebegin', newOrgHtml);
            }
            
            newOrgName.value = '';

        } catch (error) {
            addOrgMessage.textContent = error.message;
            addOrgMessage.className = 'alert alert-danger mt-2';
            addOrgMessage.style.display = 'block';
        }
    });

    // Edit Organization
    orgList.addEventListener('click', async function(e) {
        const editBtn = e.target.closest('.edit-org');
        if (!editBtn) return;

        const item = editBtn.closest('.org-item');
        const nameSpan = item.querySelector('.org-name');
        const currentName = nameSpan.textContent;

        // Create edit form
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.value = currentName;

        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-sm btn-success';
        saveBtn.innerHTML = '<i class="bi bi-check"></i>';

        const btnContainer = editBtn.parentElement;
        btnContainer.insertBefore(saveBtn, editBtn);
        editBtn.style.display = 'none';

        nameSpan.style.display = 'none';
        item.insertBefore(input, nameSpan);
        input.focus();

        const handleSave = async () => {
            const newName = input.value.trim();
            if (!newName || newName === currentName) {
                resetEdit();
                return;
            }

            try {
                const response = await fetch(EDIT_URL(item.dataset.id), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: new URLSearchParams({name: newName}),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                nameSpan.textContent = newName;
            } catch (error) {
                alert(error.message);
            } finally {
                resetEdit();
            }
        };

        const resetEdit = () => {
            nameSpan.style.display = '';
            input.remove();
            saveBtn.remove();
            editBtn.style.display = '';
        };

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') handleSave();
            if (e.key === 'Escape') resetEdit();
        });
        saveBtn.addEventListener('click', handleSave);
    });

    // Delete Organization
    orgList.addEventListener('click', async function(e) {
        const deleteBtn = e.target.closest('.delete-org');
        if (!deleteBtn) return;

        const item = deleteBtn.closest('.org-item');
        currentDeleteOrgId = item.dataset.id;

        // Reset modal form elements
        newOrgSelect.value = '';
        otherOrgContainer.style.display = 'none';
        otherOrgInput.value = '';
        addAsOrgCheckbox.checked = false;

        try {
            console.log('Sending delete check request...', {
                url: DELETE_URL(currentDeleteOrgId),
                params: {check_only: 'true'}
            });

            const response = await fetch(DELETE_URL(currentDeleteOrgId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    check_only: 'true'
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            const orgSelectionElements = document.querySelector('#newOrgSelect').closest('.mb-3');
            const modalTitle = document.querySelector('.modal-title');
            
            if (data.affected_users === 0) {
                // Simple confirmation for deletion
                modalTitle.textContent = 'Confirm Deletion';
                document.getElementById('deleteModalMessage').textContent = 
                    'Are you sure you want to delete this program/school?';
                orgSelectionElements.style.display = 'none';
            } else {
                // Show full reassignment interface
                modalTitle.textContent = 'Reassign Users';
                document.getElementById('deleteModalMessage').textContent = 
                    `This program/school has ${data.affected_users} associated user${data.affected_users !== 1 ? 's' : ''}. Please select a new program/school for ${data.affected_users !== 1 ? 'these users' : 'this user'}.`;
                orgSelectionElements.style.display = 'block';
                
                // Update organization options
                newOrgSelect.innerHTML = '<option value="">Select a program/school...</option>';
                data.organizations.forEach(org => {
                    newOrgSelect.add(new Option(org.name, org.id));
                });
                newOrgSelect.add(new Option('Other', 'other'));
            }
            
            deleteModal.show();

        } catch (error) {
            alert(error.message);
        }
    });

    // Handle organization selection in delete modal
    newOrgSelect.addEventListener('change', function() {
        otherOrgContainer.style.display = this.value === 'other' ? 'block' : 'none';
        if (this.value !== 'other') {
            otherOrgInput.value = '';
            addAsOrgCheckbox.checked = false;
        }
    });

    // Handle delete confirmation
    document.getElementById('confirmDelete').addEventListener('click', async function() {
        const affectedUsers = document.getElementById('deleteModalMessage').textContent
            .includes('associated user');
        
        if (affectedUsers) {
            const newOrg = newOrgSelect.value;
            if (!newOrg) return;

            if (newOrg === 'other' && !otherOrgInput.value.trim()) {
                alert('Please enter a new organization name');
                return;
            }
        }

        try {
            const formData = new FormData();
            if (affectedUsers) {
                formData.append('new_organization', newOrgSelect.value);
                if (newOrgSelect.value === 'other') {
                    const newOrgName = otherOrgInput.value.trim();
                    formData.append('other_organization', newOrgName);
                    const addAsOrg = addAsOrgCheckbox.checked;
                    formData.append('add_as_org', addAsOrg);
                }
            }

            const deleteResponse = await fetch(DELETE_URL(currentDeleteOrgId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData,
            });

            const data = await deleteResponse.json();
            if (!deleteResponse.ok) throw new Error(data.error);

            // Remove the old organization
            document.querySelector(`.org-item[data-id="${currentDeleteOrgId}"]`).remove();

            // If a new organization was created, add it to the list
            if (data.new_organization) {
                const newOrgHtml = createOrgElement(data.new_organization);
                
                // Find the correct position to insert alphabetically
                const orgItems = Array.from(orgList.children);
                const insertIndex = orgItems.findIndex(item => 
                    item.querySelector('.org-name').textContent.toLowerCase() > data.new_organization.name.toLowerCase()
                );

                if (insertIndex === -1) {
                    orgList.insertAdjacentHTML('beforeend', newOrgHtml);
                } else {
                    orgItems[insertIndex].insertAdjacentHTML('beforebegin', newOrgHtml);
                }
            }

            deleteModal.hide();

        } catch (error) {
            alert(error.message);
        }
    });

    function createOrgElement(org) {
        return `
            <div class="list-group-item d-flex justify-content-between align-items-center org-item" data-id="${org.id}">
                <span class="org-name">${org.name}</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary edit-org">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-org">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // Also add a handler for when the modal is hidden
    deleteModal._element.addEventListener('hidden.bs.modal', function () {
        newOrgSelect.value = '';
        otherOrgContainer.style.display = 'none';
        otherOrgInput.value = '';
        addAsOrgCheckbox.checked = false;
    });
});
</script>
{% endblock %}

{% endblock %}