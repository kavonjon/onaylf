<!-- the table displays students related to the current user, and does so through a call for student data via DRF (the view for this will be created later), and also the table has a column of buttons where one button takes you to a page to edit the student, and one button marks the student as associated with the current performance (that is loaded in the context). if a user is already associated with the performance, the button allows them to be deassociated/unselected -->

{% extends "base.html" %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load bootstrap_icons %}
{% load static %}

{% block title %}Choose students{% endblock %}

{% block featured %}
Choose Students<br />

Choose students for this performance by clicking the check mark to the right of their names. Don't see your student? You can create a new student. Once you have created a student they will be available to you for any future performance.
{% endblock %}


{% block page_content %}
<div class="included-content">
    {% include 'progress.html' %}
</div>

    <h1>Choose students</h1>

    <div class="mb-3">
        <a href="add/" class="btn btn-primary">New Student</a>
    </div>
    <table class="table table-striped student-table">
        <tbody>
            <tr>
                <th>Name</th>
                <th>Grade</th>
                <th>Hometown</th>
                <th>Actions</th>
            </tr>
        </tbody>
      </table>

    <div class="mb-3">
        <a href="../accessories/" class="btn btn-primary">Continue</a>
        <span>
            <a href="/" class="btn btn-secondary">Close and save</a>
        </span>
    </div>


<script>

    const performanceStatusIcon = document.getElementById('performanceStatusIcon');
    const instructorsStatusIcon = document.getElementById('instructorsStatusIcon');
    const instructorsStatusNumber = document.getElementById('instructorsStatusNumber');
    const instructorsStatusDiv = document.getElementById('instructorsStatusDiv');
    const studentsStatusIcon = document.getElementById('studentsStatusIcon');
    const studentsStatusNumber = document.getElementById('studentsStatusNumber');
    const studentsStatusDiv = document.getElementById('studentsStatusDiv');
    const accessoriesStatusIcon = document.getElementById('accessoriesStatusIcon');
    const accessoriesStatusDiv = document.getElementById('accessoriesStatusDiv');
    const reviewStatusIcon = document.getElementById('reviewStatusIcon');
    const reviewStatusDiv = document.getElementById('reviewStatusDiv');
    const approvalStatusIcon = document.getElementById('approvalStatusIcon');
    const approvalStatusDiv = document.getElementById('approvalStatusDiv');

    let table = document.querySelector('.student-table');
    
    class App {
        tableObjects
        tableHeader = `
    <thead>
        <tr class="row small">
            <th class="col-md-3 overflow-hidden">Name</th>
            <th class="col-md-3 overflow-hidden">Grade</th>
            <th class="col-md-3 overflow-hidden">Hometown</th>
            <th class="col-md-3 overflow-hidden">Actions</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
    `
        tableBody
        activeValue
        activeEditButton
        students
    
        constructor() {
        
            document.addEventListener('DOMContentLoaded', this._loadTable.bind(this));

            this._clickStudentPerformance = this._clickStudentPerformance.bind(this);
            document.addEventListener('DOMContentLoaded', () => {
                document.body.addEventListener('click', (e) => {
                    console.log(e.target)
                    if(e.target.closest('.include-performance-student')) {
                        this._clickStudentPerformance(e);
                    }
                });
            });

            performanceStatusIcon.classList.add("text-success")
            // Create a new DOMParser
            var parser = new DOMParser;
            // Parse the encoded string as HTML
            var dom = parser.parseFromString('<!doctype html><body>' + "{{ performance.title }}", 'text/html');
            // Get the decoded string
            var decodedString = dom.body.textContent;
            performanceStatusName.textContent = decodedString;

            const numberOfInstructors = "{{ performance.instructors.count }}";
            instructorsStatusNumber.textContent = numberOfInstructors
            if ( numberOfInstructors > 0 ) {
                instructorsStatusIcon.classList.add("text-success")
                instructorsStatusDiv.textContent = "Completed"
            } else if ( "{{ performance.instructors_status }}" == "in_progress" ) {
                    instructorsStatusIcon.classList.add("text-warning")
                    instructorsStatusDiv.textContent = "In progress"
            } else {
                    instructorsStatusIcon.classList.add("text-danger")
                    instructorsStatusDiv.textContent = "Pending"
            }

            const numberOfStudents = "{{ performance.students.count }}";
            studentsStatusNumber.textContent = numberOfStudents
            if ( numberOfStudents > 0 ) {
                studentsStatusIcon.classList.add("text-success")
                studentsStatusDiv.textContent = "Completed"
            } else if ( "{{ performance.students_status }}" == "in_progress" ) {
                    studentsStatusIcon.classList.add("text-warning")
                    studentsStatusDiv.textContent = "In progress"
            } else {
                    studentsStatusIcon.classList.add("text-danger")
                    studentsStatusDiv.textContent = "Pending"
            }

            if ( "{{ performance.accessories_status }}" == "completed" ) {
                accessoriesStatusIcon.classList.add("text-success")
                accessoriesStatusDiv.textContent = "Completed"
            } else if ( "{{ performance.accessories_status }}" == "in_progress" ) {
                accessoriesStatusIcon.classList.add("text-warning")
                accessoriesStatusDiv.textContent = "In progress"
            } else {
                accessoriesStatusIcon.classList.add("text-danger")
                accessoriesStatusDiv.textContent = "Pending"
            }

            if ( "{{ performance.review_status }}" == "completed" ) {
                reviewStatusIcon.classList.add("text-success")
                reviewStatusDiv.textContent = "Completed"
            } else if ( "{{ performance.review_status }}" == "in_progress" ) {
                reviewStatusIcon.classList.add("text-warning")
                reviewStatusDiv.textContent = "In progress"
            } else {
                reviewStatusIcon.classList.add("text-danger")
                reviewStatusDiv.textContent = "Pending"
            }

            if ( "{{ performance.status }}" == "completed" ) {
                approvalStatusIcon.classList.add("text-success")
                approvalStatusDiv.textContent = "Completed"
            } else if ( "{{ performance.status }}" == "in_progress" ) {
                approvalStatusIcon.classList.add("text-danger")
                approvalStatusDiv.textContent = "Unsubmitted"
            } else if ( "{{ performance.status }}" == "disqualified" ) {
                approvalStatusIcon.classList.add("text-danger")
                approvalStatusDiv.textContent = "Disqualified"
            } else {
                approvalStatusIcon.classList.add("text-warning")
                approvalStatusDiv.textContent = "Submitted"
            }
        }

        _getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
        _getStudents(){
    
            const user_id = "{{ performance.user.id }}";
            const headers = { 'Content-Type': 'application/json' };
            return fetch(`/api/students/?user_id=${user_id}`, { headers, })
                .then(res => res.json())
                .then(data => {
                    console.log("User's students", data);
                    this.tableObjects = data
                });
    
        }
    
        _getStudentsOnPerformanceList(){
            
            // const user_id = "{{ performance.user.id }}";
            const performance_id = "{{ performance.id }}";
            const headers = { 'Content-Type': 'application/json' };
            return fetch(`/api/students/?performance_id=${performance_id}`, { headers, })
                .then(res => res.json())
                .then(data => {
                    this.students = data.map(student => student.id);
                    console.log('students on performance', this.students)
                });

        }
    
        async _loadTable(sort=null) {
            const performance_id = "{{ performance.id }}";
            await this._getStudentsOnPerformanceList();
            await this._getStudents()
            table.innerHTML = this.tableHeader
            this.tableBody = document.querySelector('.student-table tbody');
            this.tableObjects.forEach((tableObject) => {
                const selectedSpan = this.students.includes(tableObject.id) ? 'include-performance-student-selected bg-success p-2' : "";
                const html = `
                <tr class="row small${this.students.includes(tableObject.id) ? ' highlight-yellow' : ''}" data-id="${tableObject.id}">
                    <td class="col-md-3 overflow-hidden">
                        ${tableObject.firstname} ${tableObject.lastname}    
                    </td>
                    <td class="col-md-3 overflow-hidden">
                        ${tableObject.grade_display}
                    </td>
                    <td class="col-md-3 overflow-hidden">
                        ${tableObject.hometown}, ${tableObject.state}
                    </td>
                    <td class="col-md-3 overflow-hidden">
                        <span>
                            <a class="rounded edit include-performance-student ${ selectedSpan }" href="javascript:void(0)">
                                {% bs_icon 'check' color='black' %}
                            </a>
                        </span>
                        <span class="edit edit-performance-student">
                            <a class="stealth" href="/performance/${performance_id}/students/${tableObject.id}/edit/">
                                {% bs_icon 'pencil' %}
                            </a>
                        </span>
                    </td>
                </tr>
        `;
                this.tableBody.insertAdjacentHTML('beforeend', html);
            });

        }

        async _clickStudentPerformance(e) {
            const button = e.target.closest('.include-performance-student');
            const row = e.target.closest('.row');
            const id = row.dataset.id;
            const performance_id = "{{ performance.id }}";
            let add;
            if (!button.classList.contains('include-performance-student-selected')) {
                add = true;
            } else {
                add = false;
            }
            await this._updatePerformance(performance_id, Number(id), 'students', add);
            button.classList.toggle('include-performance-student-selected');
            button.classList.toggle('bg-success');
            row.classList.toggle('highlight-yellow');
            const numberOfStudents = table.querySelectorAll('.include-performance-student-selected').length;
            studentsStatusNumber.textContent = numberOfStudents;
            if ( numberOfStudents > 0 ) {
                studentsStatusIcon.classList.remove("text-warning")
                studentsStatusIcon.classList.add("text-success")
                studentsStatusDiv.textContent = "Completed"
                await this._updatePerformancePartStatus("{{ performance.id }}", 'students_status', 'completed')

            } else {
                studentsStatusIcon.classList.remove("text-success")
                studentsStatusIcon.classList.add("text-warning")
                studentsStatusDiv.textContent = "In progress"
                await this._updatePerformancePartStatus("{{ performance.id }}", 'students_status', 'in_progress')
            }
        }

        _updatePerformance(performance_id, object, field, add=true) {
            console.log(add)
            if (add) {
                if (!this.students.includes(object)) {
                    this.students.push(object);
                }
            } else {
                if (this.students.includes(object)) {
                    const index = this.students.indexOf(object);
                    this.students.splice(index, 1);
                }
            }
            console.log(this.students)
            const body = JSON.stringify({
                [field]: this.students});
            const csrftoken = this._getCookie('csrftoken');
            const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
            return fetch(`/api/performance-update/${performance_id}/`, {
                method: 'PATCH',
                headers,
                body: body,
            })
            .then(res => {
                res.json()
                console.log(res)
            })
            .then(data => {
                console.log('Modified performance:', data);
                // Handle any further actions after modifying the performance
            })
            .catch(error => {
                console.error('Error modifying performance:', error);
                // Handle errors, if any
            });
        }
        _updatePerformancePartStatus(performance_id, field, status) {

            const body = JSON.stringify({
                [field]: status});
            const csrftoken = this._getCookie('csrftoken');
            const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken,};
            return fetch(`/api/performance-update/${performance_id}/`, {
                method: 'PATCH',
                headers,
                body: body,
            })
            .then(res => {
                res.json()
                console.log(res)
            })
            .then(data => {
                console.log('Modified performance status:', data);
                // Handle any further actions after modifying the performance
            })
            .catch(error => {
                console.error('Error modifying performance status:', error);
                // Handle errors, if any
            });
        }

    }
    const app = new App();
    </script>

{% endblock %}