{% extends "base.html" %}
{% load static %}

{% block title %}Fair details for {{ currentFair }}{% endblock %}

{% block page_content %}
{% if moderator %}
    <h2>Fair Information for {{ currentFair }}</h2>

    <p>
        <button class="btn btn-primary" id="downloadButton">Download</button>
        (Download feature is in development)
    </p>

    <h3>Performances</h3>
    <ul>
    <li>Number of submitted (and not approved) performances: {{ performances_submitted_count }}</li>
    <li>Number of approved performances: {{ performances_approved_count }}</li>
    <li>Total number of submitted and approved performances: {{ performances_total_count }}</li>
    </ul>

    <h2>Stats for approved performances:</h2>

    <h3>Categories</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Category</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for category, counts in performances_by_category.items %}
            <tr>
                <td>{{ category }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Languages</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Language</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for language, counts in performances_by_language.items %}
            <tr>
                <td>{{ language }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Grade Ranges</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Grade range</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for grade_range, counts in performances_by_grade_range.items %}
            <tr>
                <td>{{ grade_range }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>T-Shirts</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">T-shirt size</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for tshirt_size, counts in tshirt_sizes_summary.items %}
            <tr>
                <td>{{ tshirt_size }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Accessories</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Accessories</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for accessory, counts in accessories_summary.items %}
            <tr>
                <td>{{ accessory }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>



    <script>
        const downloadButton = document.getElementById('downloadButton');

        function sanitizeFilename(filename) {
            return filename.replace(/[^a-z0-9_.-]/gi, '_');
        }

        class App {
    
            constructor() {
                downloadButton.addEventListener('click', this._downloadMetadata.bind(this));
            }

            _getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            _downloadMetadata(){
                const fair_pk = "{{ fair.pk }}"
                const currentFair = "{{ currentFair }}"
                fetch(`/api/fair/${fair_pk}/download/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // Create a link and download the file
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = sanitizeFilename(`fair_${currentFair}_data.zip`);
                        document.body.appendChild(link); // Append the link to the body
                        link.click();
                        document.body.removeChild(link); // Remove the link from the body
                        window.URL.revokeObjectURL(url); // Revoke the object URL
                    })
                    .catch(error => console.error('Error:', error));
            }

        }
        const app = new App();
    </script>

{% endif %}
{% endblock %}