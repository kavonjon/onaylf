{% extends "base.html" %}
{% load static %}

{% block title %}Fair details for {{ currentFair }}{% endblock %}

{% block page_content %}
{% if moderator %}
    <h2>Fair Information for {{ currentFair }}</h2>

    <p>
        <button class="btn btn-primary" id="downloadButton">Download</button>
        (Download feature is in development)
    </p>

    <h3>Performances</h3>
    <ul>
    <li>Number of performances submitted: {{ performances_submitted_count }}</li>
    <li>Of those, number approved: {{ performances_approved_count }}</li>
    </ul>

    <h2>Stats for approved performances:</h2>

    <h3>Categories</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Category</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for category, counts in performances_by_category.items %}
            <tr>
                <td>{{ category }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Languages</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Language</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for language, counts in performances_by_language.items %}
            <tr>
                <td>{{ language }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Grade Ranges</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Grade range</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for grade_range, counts in performances_by_grade_range.items %}
            <tr>
                <td>{{ grade_range }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>T-Shirts</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">T-shirt size</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for tshirt_size, counts in tshirt_sizes_summary.items %}
            <tr>
                <td>{{ tshirt_size }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Accessories</h3>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Accessories</th>
                <th scope="col">Approved</th>
                <th scope="col">Submitted</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
        {% for accessory, counts in accessories_summary.items %}
            <tr>
                <td>{{ accessory }}</td>
                <td>{{ counts.approved }}</td>
                <td>{{ counts.submitted }}</td>
                <td>{{ counts.all }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>



    <script>
        const downloadButton = document.getElementById('downloadButton');
        class App {
    
            constructor() {
                downloadButton.addEventListener('click', this._downloadMetadata.bind(this));
            }

            _getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            _downloadMetadata(){
                const fair_pk = "{{ fair.pk }}"
                fetch(`/api/fair/${fair_pk}/download/`)
                    .then(response => response.json())
                    .then(data => {
                        // Create a blob with the data and download it
                        const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'performance_data.json';
                        link.click();
                    })
                    .catch(error => console.error('Error:', error));
            }

        }
        const app = new App();
    </script>

{% endif %}
{% endblock %}