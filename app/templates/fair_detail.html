{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load bootstrap_icons %}

{% block title %}Fair info for {{ currentFair }}{% endblock %}

{% block page_content %}
{% include 'partials/view_mode_banner.html' %}
<div class="container-fluid py-4">
    {% if moderator %}
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Fair information for {{ fair.name }}
                </h3>
            </div>
        </div>
        
        <div class="card-body">
            <div class="p-4">

                <div class="row mb-4">
                    <div class="col">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Download Options</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-3">
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-primary me-2" id="downloadButton">
                                            <i class="bi bi-download"></i> Download All Data
                                            <span class="spinner-border spinner-border-sm text-white d-none" id="spinner"></span>
                                        </button>
                                        <small class="text-muted">(This can take a minute or two)</small>
                                    </div>

                <div class="d-flex mt-3 mb-2">
                    <div>
                        <button class="btn btn-primary me-2" id="downloadRegistrationCoverSheetsButton">
                            <i class="bi bi-file-text"></i> Download Registration Cover Sheets
                            <span class="spinner-border spinner-border-sm d-none" id="spinner-registration-cover-sheets"></span>
                        </button>
                    </div>
                </div>

                <div class="d-flex mt-3 mb-2">
                    <div>
                        <button class="btn btn-primary me-2" id="downloadSubmissionSheetsButton">
                            <i class="bi bi-file-text"></i> Download Submission Sheets
                            <span class="spinner-border spinner-border-sm d-none" id="spinner-submission-sheets"></span>
                        </button>
                    </div>
                </div>

                <div class="d-flex mt-3 mb-2">
                    <div>
                        <button class="btn btn-primary me-1" id="downloadSubmissionCardsButton">
                            <i class="bi bi-file-text"></i> Download Submission Cards
                            <span class="spinner-border spinner-border-sm d-none" id="spinner-submission-cards"></span>
                        </button>
                    </div>
                </div>

                <div class="d-flex mt-3 mb-2">
                    <div>
                        <button class="btn btn-primary me-1" id="downloadJudgeSheetsButton">
                            <i class="bi bi-file-text"></i> Download Judge Sheets
                            <span class="spinner-border spinner-border-sm d-none" id="spinner-judge"></span>
                        </button>
                    </div>
                </div>

                <!-- Stats section -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="fairStats" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="submissions-tab" data-bs-toggle="tab" data-bs-target="#submissions">
                                    <i class="bi bi-file-text"></i> Stats for Submissions
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="programs-tab" data-bs-toggle="tab" data-bs-target="#programs">
                                    <i class="bi bi-building"></i> Stats for Programs
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab" aria-controls="students" aria-selected="false">
                                    <i class="bi bi-people"></i> Stats for Students
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="languages-tab" data-bs-toggle="tab" data-bs-target="#languages">
                                    <i class="bi bi-translate"></i> Stats for Languages
                                </button>
                            </li>
                        </ul>
                    </div>

                <!-- Tab content -->
                <div class="tab-content" id="fairStatsContent">
                    <!-- Submissions Tab -->
                    <div class="tab-pane fade show active" id="submissions" role="tabpanel" aria-labelledby="submissions-tab">
                        <div class="mb-4 p-4">
                            <h5 class="border-bottom pb-2">Submissions Overview</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Submission Counts</h6>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Pending Approval
                                                    <span class="badge bg-warning rounded-pill">{{ submissions_submitted_count }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Approved
                                                    <span class="badge bg-success rounded-pill">{{ submissions_approved_count }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Total
                                                    <span class="badge bg-primary rounded-pill">{{ submissions_total_count }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Student Counts</h6>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    In Pending Submissions
                                                    <span class="badge bg-warning rounded-pill">{{ students_submitted }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    In Approved Submissions
                                                    <span class="badge bg-success rounded-pill">{{ students_approved }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Total Students
                                                    <span class="badge bg-primary rounded-pill">{{ students_total }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Categories</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Category</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for category, counts in submissions_by_category.items %}
                                            <tr>
                                                <td class="w-50">{{ category }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ counts.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ counts.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ counts.all }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Languages</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Language</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for language, counts in submissions_by_language.items %}
                                            <tr>
                                                <td class="w-50">{{ language }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ counts.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ counts.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ counts.all }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Grade Ranges</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Grade range</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for grade_range, counts in submissions_by_grade_range.items %}
                                            <tr>
                                                <td class="w-50">{{ grade_range }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ counts.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ counts.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ counts.all }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">T-Shirts</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">T-shirt size</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for tshirt_size, counts in tshirt_sizes_summary.items %}
                                            <tr>
                                                <td class="w-50">{{ tshirt_size }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ counts.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ counts.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ counts.all }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Bag Count</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Status</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="w-50">Count</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ bag_count.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ bag_count.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ bag_count.all }}</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Programs Tab -->
                    <div class="tab-pane fade" id="programs" role="tabpanel" aria-labelledby="programs-tab">
                        <div class="mb-4 p-4">
                            <h5 class="border-bottom pb-2">Programs Overview</h5>
                            <div class="row">
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Program Counts</h6>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    With Pending Submissions
                                                    <span class="badge bg-warning rounded-pill">{{ programs_submitted_count }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    With Approved Submissions
                                                    <span class="badge bg-success rounded-pill">{{ programs_approved_count }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Total Programs
                                                    <span class="badge bg-primary rounded-pill">{{ programs_total_count }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Programs by Grade Range</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Grade Range</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="w-50">PreK-5</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ prek5_programs.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ prek5_programs.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ prek5_programs.all }}</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="w-50">6-12</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ grade612_programs.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ grade612_programs.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ grade612_programs.all }}</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Programs by Language card - add this after the grade range card -->
                        <div class="row mt-4">
                            <div class="col">
                                <div class="card m-4 p-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Programs by Language</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="w-50" scope="col">Language</th>
                                                        <th class="text-center" scope="col">Approved</th>
                                                        <th class="text-center" scope="col">Submitted</th>
                                                        <th class="text-center" scope="col">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for language, counts in programs_by_language.items %}
                                                    <tr>
                                                        <td class="w-50">{{ language }}</td>
                                                        <td class="text-center">
                                                            <span class="badge bg-success">{{ counts.approved }}</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-warning">{{ counts.submitted }}</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-primary">{{ counts.all }}</span>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Students Tab -->
                    <div class="tab-pane fade" id="students" role="tabpanel" aria-labelledby="students-tab">
                        <div class="mb-4 p-4">
                            <h5 class="border-bottom pb-2">Students Overview</h5>
                            <div class="row">
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Student Counts</h6>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    In Pending Submissions
                                                    <span class="badge bg-warning rounded-pill">{{ students_submitted }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    In Approved Submissions
                                                    <span class="badge bg-success rounded-pill">{{ students_approved }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Total Students
                                                    <span class="badge bg-primary rounded-pill">{{ students_total }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Students by Language</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Language</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for language, counts in students_by_language.items %}
                                            <tr>
                                                <td class="w-50">{{ language }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ counts.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ counts.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ counts.all }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Languages Tab -->
                    <div class="tab-pane fade" id="languages" role="tabpanel" aria-labelledby="languages-tab">
                        <div class="mb-4 p-4">
                            <h5 class="border-bottom pb-2">Languages Overview</h5>
                            <div class="row">
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Language Counts</h6>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    In Pending Submissions
                                                    <span class="badge bg-warning rounded-pill">{{ languages_submitted_count }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    In Approved Submissions
                                                    <span class="badge bg-success rounded-pill">{{ languages_approved_count }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Total Languages
                                                    <span class="badge bg-primary rounded-pill">{{ languages_total_count }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card m-4 p-4">
                            <div class="card-header">
                                <h5 class="mb-0">Languages by Grade Range</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50" scope="col">Grade Range</th>
                                                <th class="text-center" scope="col">Approved</th>
                                                <th class="text-center" scope="col">Submitted</th>
                                                <th class="text-center" scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="w-50">PreK-5</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ prek5_languages.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ prek5_languages.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ prek5_languages.all }}</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="w-50">6-12</td>
                                                <td class="text-center">
                                                    <span class="badge bg-success">{{ grade612_languages.approved }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-warning">{{ grade612_languages.submitted }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ grade612_languages.all }}</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this after the container div -->
<div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'block'; // Show immediately

            const viewFairId = localStorage.getItem('viewFairId');
            const fairParam = viewFairId ? `?fair_id=${viewFairId}` : '';

            // Check if we need to redirect
            if (viewFairId && !window.location.search.includes('fair_id')) {
                window.location.href = window.location.pathname + fairParam;
            } else {
                // We're already on the correct page, hide the overlay
                loadingOverlay.style.display = 'none';
            }

            // Handle exit view mode
            const exitViewModeBtn = document.getElementById('exitViewMode');
            if (exitViewModeBtn) {
                exitViewModeBtn.addEventListener('click', function() {
                    localStorage.removeItem('viewFairId');
                    localStorage.removeItem('viewFairName');
                    // Remove fair_id from URL before reloading
                    window.location.href = window.location.pathname;
                });
            }
        });

        const viewFairId = localStorage.getItem('viewFairId');
        const fair_pk_to_use = viewFairId || "{{ fair.pk }}";

        const downloadButton = document.getElementById('downloadButton');
        const spinner = document.getElementById('spinner');
        const downloadRegistrationCoverSheetsButton = document.getElementById('downloadRegistrationCoverSheetsButton');
        const spinnerRegistrationCoverSheets = document.getElementById('spinner-registration-cover-sheets');
        const downloadSubmissionSheetsButton = document.getElementById('downloadSubmissionSheetsButton');
        const spinnerSubmissionSheets = document.getElementById('spinner-submission-sheets');
        const downloadSubmissionCardsButton = document.getElementById('downloadSubmissionCardsButton');
        const spinnerSubmissionCards = document.getElementById('spinner-submission-cards');
        const downloadJudgeSheetsButton = document.getElementById('downloadJudgeSheetsButton');
        const spinnerJudge = document.getElementById('spinner-judge');

        function sanitizeFilename(filename) {
            return filename.replace(/[^a-z0-9_.-]/gi, '_');
        }

        class App {
    
            constructor() {
                this.fairName = "{{ fair.name }}";  // Get the fair name from the template context
                downloadButton.addEventListener('click', this._downloadMetadata.bind(this));
                downloadRegistrationCoverSheetsButton.addEventListener('click', this._downloadRegistrationCoverSheets.bind(this));
                downloadSubmissionSheetsButton.addEventListener('click', this._downloadSubmissionSheets.bind(this));
                downloadSubmissionCardsButton.addEventListener('click', this._downloadSubmissionCards.bind(this));
                downloadJudgeSheetsButton.addEventListener('click', this._downloadJudgeSheets.bind(this));
            }

            _getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            _downloadMetadata(){
                downloadButton.disabled = true;
                downloadButton.classList.remove('btn-primary');
                downloadButton.classList.add('btn-secondary');
                spinner.classList.remove('d-none');
                fetch(`/api/fair/${fair_pk_to_use}/download/`)
                    .then(response => {
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            if (contentType && contentType.includes("application/json")) {
                                return response.json().then(err => { throw new Error(`HTTP error! status: ${response.status}, message: ${err.error}`); });
                            } else {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                        }
                        if (contentType && contentType.includes("application/zip")) {
                            return response.blob();
                        }
                        throw new Error(`Unexpected content-type: ${contentType}`);
                    })
                    .then(blob => {
                        // Create a link and download the file
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = sanitizeFilename(`fair-${this.fairName}-data.zip`);
                        document.body.appendChild(link); // Append the link to the body
                        link.click();
                        document.body.removeChild(link); // Remove the link from the body
                        window.URL.revokeObjectURL(url); // Revoke the object URL
                        downloadButton.disabled = false;
                        downloadButton.classList.remove('btn-secondary');
                        downloadButton.classList.add('btn-primary');
                        spinner.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        downloadButton.disabled = false;
                        downloadButton.classList.remove('btn-secondary');
                        downloadButton.classList.add('btn-primary');
                        spinner.classList.add('d-none');
                    });
            }

            _downloadRegistrationCoverSheets(){
                downloadRegistrationCoverSheetsButton.disabled = true;
                downloadRegistrationCoverSheetsButton.classList.remove('btn-primary');
                downloadRegistrationCoverSheetsButton.classList.add('btn-secondary');
                spinnerRegistrationCoverSheets.classList.remove('d-none');
                fetch(`/api/fair/${fair_pk_to_use}/download-registration-cover-sheets/`)
                    .then(response => {
                        console.log(response);
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            if (contentType && contentType.includes("application/json")) {
                                return response.json().then(err => { throw new Error(`HTTP error! status: ${response.status}, message: ${err.error}`); });
                            } else {
                                throw new Error(`HTTP error! status: ${response.status}, response: ${response}`);
                            }
                        }
                        if (contentType && contentType.includes("application/pdf")) {
                            return response.blob();
                        }
                        throw new Error(`Unexpected content-type: ${contentType}`);
                    })
                    .then(blob => {
                        // Create a link and download the file
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = sanitizeFilename(`fair-${this.fairName}-registration_cover_sheets.pdf`);
                        document.body.appendChild(link); // Append the link to the body
                        link.click();
                        document.body.removeChild(link); // Remove the link from the body
                        window.URL.revokeObjectURL(url); // Revoke the object URL
                        downloadRegistrationCoverSheetsButton.disabled = false;
                        downloadRegistrationCoverSheetsButton.classList.remove('btn-secondary');
                        downloadRegistrationCoverSheetsButton.classList.add('btn-primary');
                        spinnerRegistrationCoverSheets.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        downloadRegistrationCoverSheetsButton.disabled = false;
                        downloadRegistrationCoverSheetsButton.classList.remove('btn-secondary');
                        downloadRegistrationCoverSheetsButton.classList.add('btn-primary');
                        spinnerRegistrationCoverSheets.classList.add('d-none');
                    });
            }

            _downloadSubmissionSheets(){
                downloadSubmissionSheetsButton.disabled = true;
                downloadSubmissionSheetsButton.classList.remove('btn-primary');
                downloadSubmissionSheetsButton.classList.add('btn-secondary');
                spinnerSubmissionSheets.classList.remove('d-none');
                fetch(`/api/fair/${fair_pk_to_use}/download-submission-sheets/`)
                    .then(response => {
                        console.log(response);
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            if (contentType && contentType.includes("application/json")) {
                                return response.json().then(err => { throw new Error(`HTTP error! status: ${response.status}, message: ${err.error}`); });
                            } else {
                                throw new Error(`HTTP error! status: ${response.status}, response: ${response}`);
                            }
                        }
                        if (contentType && contentType.includes("application/pdf")) {
                            return response.blob();
                        }
                        throw new Error(`Unexpected content-type: ${contentType}`);
                    })
                    .then(blob => {
                        // Create a link and download the file
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = sanitizeFilename(`fair-${this.fairName}-submission_sheets.pdf`);
                        document.body.appendChild(link); // Append the link to the body
                        link.click();
                        document.body.removeChild(link); // Remove the link from the body
                        window.URL.revokeObjectURL(url); // Revoke the object URL
                        downloadSubmissionSheetsButton.disabled = false;
                        downloadSubmissionSheetsButton.classList.remove('btn-secondary');
                        downloadSubmissionSheetsButton.classList.add('btn-primary');
                        spinnerSubmissionSheets.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        downloadSubmissionSheetsButton.disabled = false;
                        downloadSubmissionSheetsButton.classList.remove('btn-secondary');
                        downloadSubmissionSheetsButton.classList.add('btn-primary');
                        spinnerSubmissionSheets.classList.add('d-none');
                    });
            }

            _downloadSubmissionCards(){
                downloadSubmissionCardsButton.disabled = true;
                downloadSubmissionCardsButton.classList.remove('btn-primary');
                downloadSubmissionCardsButton.classList.add('btn-secondary');
                spinnerSubmissionCards.classList.remove('d-none');
                fetch(`/api/fair/${fair_pk_to_use}/download-submission-cards/`)
                    .then(response => {
                        console.log(response);
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            if (contentType && contentType.includes("application/json")) {
                                return response.json().then(err => { throw new Error(`HTTP error! status: ${response.status}, message: ${err.error}`); });
                            } else {
                                throw new Error(`HTTP error! status: ${response.status}, response: ${response}`);
                            }
                        }
                        if (contentType && contentType.includes("application/pdf")) {
                            return response.blob();
                        }
                        throw new Error(`Unexpected content-type: ${contentType}`);
                    })
                    .then(blob => {
                        // Create a link and download the file
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = sanitizeFilename(`fair-${this.fairName}-submission_cards.pdf`);
                        document.body.appendChild(link); // Append the link to the body
                        link.click();
                        document.body.removeChild(link); // Remove the link from the body
                        window.URL.revokeObjectURL(url); // Revoke the object URL
                        downloadSubmissionCardsButton.disabled = false;
                        downloadSubmissionCardsButton.classList.remove('btn-secondary');
                        downloadSubmissionCardsButton.classList.add('btn-primary');
                        spinnerSubmissionCards.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        downloadSubmissionCardsButton.disabled = false;
                        downloadSubmissionCardsButton.classList.remove('btn-secondary');
                        downloadSubmissionCardsButton.classList.add('btn-primary');
                        spinnerSubmissionCards.classList.add('d-none');
                    });
            }

            _downloadJudgeSheets(){
                downloadJudgeSheetsButton.disabled = true;
                downloadJudgeSheetsButton.classList.remove('btn-primary');
                downloadJudgeSheetsButton.classList.add('btn-secondary');
                spinnerJudge.classList.remove('d-none');
                fetch(`/api/fair/${fair_pk_to_use}/download-judge-sheets/`)
                    .then(response => {
                        console.log(response);
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            if (contentType && contentType.includes("application/json")) {
                                return response.json().then(err => { throw new Error(`HTTP error! status: ${response.status}, message: ${err.error}`); });
                            } else {
                                throw new Error(`HTTP error! status: ${response.status}, response: ${response}`);
                            }
                        }
                        if (contentType && contentType.includes("application/pdf")) {
                            return response.blob();
                        }
                        throw new Error(`Unexpected content-type: ${contentType}`);
                    })
                    .then(blob => {
                        // Create a link and download the file
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = sanitizeFilename(`fair-${this.fairName}-judge_sheets.pdf`);
                        document.body.appendChild(link); // Append the link to the body
                        link.click();
                        document.body.removeChild(link); // Remove the link from the body
                        window.URL.revokeObjectURL(url); // Revoke the object URL
                        downloadJudgeSheetsButton.disabled = false;
                        downloadJudgeSheetsButton.classList.remove('btn-secondary');
                        downloadJudgeSheetsButton.classList.add('btn-primary');
                        spinnerJudge.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        downloadJudgeSheetsButton.disabled = false;
                        downloadJudgeSheetsButton.classList.remove('btn-secondary');
                        downloadJudgeSheetsButton.classList.add('btn-primary');
                        spinnerJudge.classList.add('d-none');
                    });
            }
        }
        const app = new App();
    </script>

{% endif %}
{% endblock %}